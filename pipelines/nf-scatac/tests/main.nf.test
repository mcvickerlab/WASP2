nextflow_pipeline {

    name "Test Pipeline nf-scatac"
    script "../main.nf"

    tag "pipeline"
    tag "scatac"

    test("nf-scatac - stub run") {

        options "-stub -profile test_stub"

        when {
            params {
                outdir = "$outputDir"
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert workflow.out.cell_counts != null },
                { assert workflow.out.anndata != null },
                { assert workflow.out.imbalance != null },
                { assert snapshot(
                    workflow.trace.tasks().size(),
                    workflow.trace.tasks()*.name.sort()
                ).match("stub_workflow_tasks") }
            )
        }
    }
}

nextflow_workflow {

    name "Test Workflow SCATAC"
    script "../workflows/scatac.nf"
    workflow "SCATAC"

    tag "scatac"
    tag "workflow"

    test("SCATAC workflow - stub run with all features") {

        options "-stub"

        when {
            params {
                vcf = "${projectDir}/tests/stub/variants.vcf.gz"
                outdir = "$outputDir"
                create_zarr = true
            }
            workflow {
                """
                input[0] = Channel.of([
                    [
                        id: 'test_sample',
                        single_end: false,
                        cell_barcode_tag: 'CB',
                        chemistry: '10x-atac-v2'
                    ],
                    file("${projectDir}/tests/stub/fragments.tsv.gz"),
                    file("${projectDir}/tests/stub/fragments.tsv.gz.tbi"),
                    file('NO_FILE'),  // barcodes (optional)
                    file('NO_FILE')   // peaks (optional)
                ])
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert workflow.out.cell_counts.size() == 1 },
                { assert workflow.out.anndata.size() == 1 },
                { assert workflow.out.imbalance.size() == 1 },
                { assert snapshot(workflow.out.versions).match("scatac_versions") }
            )
        }
    }

    test("SCATAC workflow - skip anndata and pseudobulk") {

        options "-stub"

        when {
            params {
                vcf = "${projectDir}/tests/stub/variants.vcf.gz"
                outdir = "$outputDir"
                skip_anndata = true
                skip_pseudobulk = true
            }
            workflow {
                """
                input[0] = Channel.of([
                    [
                        id: 'test_sample',
                        single_end: false,
                        cell_barcode_tag: 'CB',
                        chemistry: '10x-atac-v2'
                    ],
                    file("${projectDir}/tests/stub/fragments.tsv.gz"),
                    file("${projectDir}/tests/stub/fragments.tsv.gz.tbi"),
                    file('NO_FILE'),
                    file('NO_FILE')
                ])
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert workflow.out.cell_counts.size() == 1 },
                // anndata and imbalance should be empty when skipped
                { assert workflow.out.anndata.size() == 0 },
                { assert workflow.out.imbalance.size() == 0 }
            )
        }
    }

    test("SCATAC workflow - fails without required vcf param") {

        options "-stub"

        when {
            params {
                vcf = null
                outdir = "$outputDir"
            }
            workflow {
                """
                input[0] = Channel.of([
                    [
                        id: 'test_sample',
                        single_end: false,
                        cell_barcode_tag: 'CB',
                        chemistry: '10x-atac-v2'
                    ],
                    file("${projectDir}/tests/stub/fragments.tsv.gz"),
                    file("${projectDir}/tests/stub/fragments.tsv.gz.tbi"),
                    file('NO_FILE'),
                    file('NO_FILE')
                ])
                """
            }
        }

        then {
            assert workflow.failed
        }
    }
}

nextflow_process {

    name "Test Process SCATAC_COUNT_ALLELES"
    script "../modules/local/scatac_count_alleles/main.nf"
    process "SCATAC_COUNT_ALLELES"

    tag "scatac"
    tag "module"
    tag "scatac_count_alleles"

    test("SCATAC_COUNT_ALLELES - stub with no filtering") {

        options "-stub"

        when {
            params {
                min_fragments_per_cell = 0
            }
            process {
                """
                input[0] = [
                    [
                        id: 'test_cell',
                        single_end: false,
                        cell_barcode_tag: 'CB',
                        chemistry: '10x-atac-v2'
                    ],
                    file("${projectDir}/tests/stub/fragments.tsv.gz"),
                    file("${projectDir}/tests/stub/fragments.tsv.gz.tbi"),
                    file("${projectDir}/tests/stub/variants.bed")
                ]
                input[1] = file('NO_FILE')  // barcodes
                input[2] = file('NO_FILE')  // peaks
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out.versions).match("count_alleles_versions") },
                { assert process.out.counts.size() == 1 },
                { assert process.out.stats.size() == 1 },
                { assert file(process.out.counts[0][1]).exists() },
                { assert file(process.out.counts[0][1]).text.contains("barcode") }
            )
        }
    }
}

nextflow_process {

    name "Test Process SCATAC_CREATE_ANNDATA"
    script "../modules/local/scatac_create_anndata/main.nf"
    process "SCATAC_CREATE_ANNDATA"

    tag "scatac"
    tag "module"
    tag "scatac_create_anndata"

    test("SCATAC_CREATE_ANNDATA - stub") {

        options "-stub"

        when {
            process {
                """
                // Create a minimal test allele counts file
                def counts_content = '''barcode\\tchrom\\tpos\\tref\\talt\\toverlap_count
AAACGAAC-1\\tchr1\\t100\\tA\\tG\\t5
AAACGAAC-1\\tchr1\\t200\\tC\\tT\\t3
AAACGAAT-1\\tchr1\\t100\\tA\\tG\\t8
'''
                def counts_file = file("${workDir}/test_allele_counts.tsv")
                counts_file.text = counts_content

                input[0] = [
                    [id: 'test_sample', chemistry: '10x-atac-v2'],
                    counts_file
                ]
                input[1] = false  // create_zarr
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert process.out.anndata.size() == 1 },
                { assert process.out.cell_qc.size() == 1 },
                { assert file(process.out.anndata[0][1]).name.endsWith('.h5ad') }
            )
        }
    }

    test("SCATAC_CREATE_ANNDATA - stub with zarr") {

        options "-stub"

        when {
            process {
                """
                def counts_content = '''barcode\\tchrom\\tpos\\tref\\talt\\toverlap_count
AAACGAAC-1\\tchr1\\t100\\tA\\tG\\t5
'''
                def counts_file = file("${workDir}/test_allele_counts.tsv")
                counts_file.text = counts_content

                input[0] = [
                    [id: 'test_sample', chemistry: '10x-atac-v2'],
                    counts_file
                ]
                input[1] = true  // create_zarr
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert process.out.anndata.size() == 1 },
                { assert process.out.zarr.size() == 1 }
            )
        }
    }
}

nextflow_process {

    name "Test Process SCATAC_PSEUDOBULK"
    script "../modules/local/scatac_pseudobulk/main.nf"
    process "SCATAC_PSEUDOBULK"

    tag "scatac"
    tag "module"
    tag "scatac_pseudobulk"

    test("SCATAC_PSEUDOBULK - stub") {

        options "-stub"

        when {
            params {
                min_cells_per_snp = 1
            }
            process {
                """
                def counts_content = '''barcode\\tchrom\\tpos\\tref\\talt\\toverlap_count
AAACGAAC-1\\tchr1\\t100\\tA\\tG\\t5
AAACGAAT-1\\tchr1\\t100\\tA\\tG\\t8
AAACGAAC-1\\tchr1\\t200\\tC\\tT\\t3
'''
                def counts_file = file("${workDir}/test_allele_counts.tsv")
                counts_file.text = counts_content

                input[0] = [
                    [id: 'test_sample'],
                    counts_file
                ]
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert process.out.counts.size() == 1 },
                { assert process.out.stats.size() == 1 },
                { assert file(process.out.counts[0][1]).text.contains("ref_count") }
            )
        }
    }
}

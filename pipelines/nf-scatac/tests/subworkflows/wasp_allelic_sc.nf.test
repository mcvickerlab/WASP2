nextflow_workflow {

    name "Test Workflow WASP_ALLELIC_SC"
    script "../../subworkflows/local/wasp_allelic_sc/main.nf"
    workflow "WASP_ALLELIC_SC"

    tag "scatac"
    tag "subworkflow"
    tag "wasp_allelic_sc"

    test("WASP_ALLELIC_SC - stub: Should count alleles per cell") {

        options "-stub"

        when {
            params {
                min_fragments_per_cell = 100
            }
            workflow {
                """
                // Fragments input
                input[0] = Channel.of([
                    [
                        id: 'test_sample',
                        single_end: false,
                        cell_barcode_tag: 'CB',
                        chemistry: '10x-atac-v2'
                    ],
                    file("${projectDir}/tests/stub/fragments.tsv.gz"),
                    file("${projectDir}/tests/stub/fragments.tsv.gz.tbi")
                ])

                // VCF input
                input[1] = Channel.of([
                    [ id: 'variants' ],
                    file("${projectDir}/tests/stub/variants.vcf.gz"),
                    file("${projectDir}/tests/stub/variants.vcf.gz.tbi")
                ])
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert workflow.out.cell_counts },
                { assert workflow.out.imbalance },
                { assert workflow.out.versions },
                { assert workflow.out.cell_counts[0][0].cell_barcode_tag == 'CB' },
                { assert snapshot(workflow.out.versions).match("wasp_allelic_sc_versions") }
            )
        }
    }

    test("WASP_ALLELIC_SC - stub: Multiple samples") {

        options "-stub"

        when {
            params {
                min_fragments_per_cell = 100
            }
            workflow {
                """
                // Multiple fragments inputs
                input[0] = Channel.of(
                    [
                        [ id: 'sample1', single_end: false, cell_barcode_tag: 'CB', chemistry: '10x-atac-v2' ],
                        file("${projectDir}/tests/stub/fragments.tsv.gz"),
                        file("${projectDir}/tests/stub/fragments.tsv.gz.tbi")
                    ],
                    [
                        [ id: 'sample2', single_end: false, cell_barcode_tag: 'CB', chemistry: '10x-atac-v1' ],
                        file("${projectDir}/tests/stub/fragments.tsv.gz"),
                        file("${projectDir}/tests/stub/fragments.tsv.gz.tbi")
                    ]
                )

                // VCF input (shared across samples)
                input[1] = Channel.of([
                    [ id: 'variants' ],
                    file("${projectDir}/tests/stub/variants.vcf.gz"),
                    file("${projectDir}/tests/stub/variants.vcf.gz.tbi")
                ])
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert workflow.out.cell_counts.size() == 2 },
                { assert workflow.out.imbalance.size() == 2 },
                { assert workflow.out.cell_counts*.get(0)*.id.sort() == ['sample1', 'sample2'] }
            )
        }
    }
}

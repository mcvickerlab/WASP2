/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    nf-scatac Nextflow config file
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

manifest {
    name            = 'nf-scatac'
    author          = 'WASP2 Team'
    description     = 'Single-Cell ATAC-seq Allelic Imbalance Pipeline'
    mainScript      = 'main.nf'
    nextflowVersion = '!>=23.04.0'
    version         = '1.0.0'
}

params {
    // Required inputs
    input                   = null
    vcf                     = null
    outdir                  = './results'

    // Processing parameters
    min_fragments_per_cell  = 1000    // Minimum fragments per cell to include
    min_cells_per_snp       = 3       // Minimum cells per SNP for pseudo-bulk
    min_count               = 10      // Minimum count for imbalance testing
    pseudocount             = 1       // Pseudocount for imbalance calculation

    // Output options
    create_zarr             = false   // Also output Zarr format for GenVarLoader
    skip_anndata            = false   // Skip AnnData H5AD creation
    skip_pseudobulk         = false   // Skip pseudo-bulk aggregation and analysis

    // Publishing
    publish_dir_mode        = 'copy'

    // ML Output options
    output_format           = null     // ML output formats: zarr,parquet,anndata (comma-separated)

    // Resource limits
    max_cpus                = 16
    max_memory              = '128.GB'
    max_time                = '240.h'

    // Pipeline options
    help                    = false
    version                 = false
    validate_params         = true
    tracedir                = "${params.outdir}/pipeline_info"
}

includeConfig 'conf/base.config'
includeConfig 'conf/modules.config'

profiles {
    docker {
        docker.enabled          = true
        docker.runOptions       = '-u $(id -u):$(id -g)'
    }
    singularity {
        singularity.enabled     = true
        singularity.autoMounts  = true
    }
    conda {
        conda.enabled           = true
        process.conda           = "${projectDir}/../../environment.yml"
    }
    test_stub {
        includeConfig 'conf/test_stub.config'
    }
    test_real {
        includeConfig 'conf/test_real.config'
    }
}

def trace_timestamp = new java.util.Date().format('yyyy-MM-dd_HH-mm-ss')
timeline { enabled = true; file = "${params.tracedir}/timeline_${trace_timestamp}.html" }
report { enabled = true; file = "${params.tracedir}/report_${trace_timestamp}.html" }
trace { enabled = true; file = "${params.tracedir}/trace_${trace_timestamp}.txt" }

process.shell = ['/bin/bash', '-euo', 'pipefail']

// Resource limit checker with logging for configuration errors
def check_max(obj, type) {
    if (type == 'memory') {
        try {
            if (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1)
                return params.max_memory as nextflow.util.MemoryUnit
            else return obj
        } catch (Exception e) {
            log.warn "Invalid memory config (${obj}, max=${params.max_memory}): ${e.message}. Using ${obj}"
            return obj
        }
    } else if (type == 'time') {
        try {
            if (obj.compareTo(params.max_time as nextflow.util.Duration) == 1)
                return params.max_time as nextflow.util.Duration
            else return obj
        } catch (Exception e) {
            log.warn "Invalid time config (${obj}, max=${params.max_time}): ${e.message}. Using ${obj}"
            return obj
        }
    } else if (type == 'cpus') {
        try { return Math.min(obj, params.max_cpus as int) }
        catch (Exception e) {
            log.warn "Invalid CPU config (${obj}, max=${params.max_cpus}): ${e.message}. Using ${obj}"
            return obj
        }
    }
}

nextflow_pipeline {

    name "Integration Test Pipeline RNASEQ_ASE"
    script "../main.nf"

    tag "pipeline"
    tag "integration"
    tag "wasp2"
    tag "rnaseq_ase"

    test("RNASEQ_ASE - integration test - full pipeline") {

        when {
            params {
                input      = "${projectDir}/tests/data/integration/samplesheet_integration.csv"
                vcf        = "${projectDir}/tests/data/integration/integration.vcf.gz"
                star_index = "${projectDir}/tests/data/integration/star_index"
                gtf        = "${projectDir}/tests/data/integration/integration.gtf"
                outdir     = "${outputDir}/results"
                min_count  = 1
            }
        }

        then {
            // Pipeline completes successfully
            assert workflow.success

            // Workflow emits expected channels
            assert workflow.out.wasp_bam != null
            assert workflow.out.counts != null
            assert workflow.out.results != null
            assert workflow.out.versions != null

            // Validate WASP-filtered BAM output
            def bamFiles = workflow.out.wasp_bam.collect { it[1] }
            assert bamFiles.size() > 0 : "No WASP BAM files produced"
            bamFiles.each { bam ->
                assert path(bam).exists() : "BAM file does not exist: ${bam}"
                assert path(bam).size() > 200 : "BAM file appears empty: ${bam}"
            }

            // Validate counts output structure
            def countsFiles = workflow.out.counts.collect { it[1] }
            assert countsFiles.size() > 0 : "No counts files produced"
            countsFiles.each { counts ->
                assert path(counts).exists() : "Counts file does not exist: ${counts}"
                def lines = path(counts).readLines()
                assert lines.size() > 0 : "Counts file is empty"
                assert lines[0].contains('\t') : "Counts should be tab-delimited"
                if (lines.size() > 1) {
                    assert lines[1].split('\t').size() >= 4 : "Counts should have >= 4 columns"
                }
            }

            // Validate analysis results
            def resultsFiles = workflow.out.results.collect { it[1] }
            assert resultsFiles.size() > 0 : "No results files produced"
            resultsFiles.each { result ->
                assert path(result).exists() : "Results file does not exist: ${result}"
                assert path(result).text.length() > 0 : "Results file is empty"
            }
        }
    }
}

nextflow_pipeline {

    name "Test Pipeline RNASEQ_ASE"
    script "../main.nf"

    tag "pipeline"
    tag "wasp2"
    tag "rnaseq_ase"

    // Shared constants to avoid duplication (no 'def' for binding-level scope)
    countsHeader = "chrom\tpos\tref\talt\tregion\tref_count\talt_count\tother_count\tN"
    aiResultsHeader = "region\tsnp_count\tref_sum\talt_sum\tmu\tnull_ll\talt_ll\tLRT\tpvalue\tfdr"

    test("RNASEQ_ASE - stub run - validates output structure and format") {

        options "-stub -profile test_stub"

        when {
            params {
                input      = "${projectDir}/assets/samplesheet_test.csv"
                vcf        = "${projectDir}/tests/data/test_snps.vcf.gz"
                star_index = "${projectDir}/tests/data/star_index"
                gtf        = "${projectDir}/tests/data/test.gtf"
                outdir     = "${outputDir}/results"
            }
        }

        then {
            assertAll(
                { assert workflow.success },

                // Workflow channels populated
                { assert workflow.out.wasp_bam != null },
                { assert workflow.out.counts != null },
                { assert workflow.out.results != null },
                { assert workflow.out.versions != null },
                { assert workflow.out.wasp_bam.size() == 2, "Expected 2 WASP BAM outputs" },
                { assert workflow.out.counts.size() == 2, "Expected 2 counts outputs" },
                { assert workflow.out.results.size() == 2, "Expected 2 AI results outputs" },

                // Snapshot for regression tracking
                { assert snapshot(
                    workflow.trace.tasks().size(),
                    workflow.trace.tasks()*.name.sort()
                ).match("stub_workflow_tasks") },

                // Output directories exist
                { assert path("${outputDir}/results/wasp_filtered").exists() },
                { assert path("${outputDir}/results/counts").exists() },
                { assert path("${outputDir}/results/analysis").exists() },

                // SAMPLE1 outputs
                { assert path("${outputDir}/results/wasp_filtered/SAMPLE1_wasp_filt.bam").exists() },
                { assert path("${outputDir}/results/wasp_filtered/SAMPLE1_wasp_filt.bam.bai").exists() },
                { assert path("${outputDir}/results/wasp_filtered/SAMPLE1.filter_stats.txt").exists() },
                { assert path("${outputDir}/results/counts/SAMPLE1_counts.tsv").exists() },
                { assert path("${outputDir}/results/analysis/SAMPLE1_ai_results.tsv").exists() },

                // SAMPLE2 outputs
                { assert path("${outputDir}/results/wasp_filtered/SAMPLE2_wasp_filt.bam").exists() },
                { assert path("${outputDir}/results/wasp_filtered/SAMPLE2_wasp_filt.bam.bai").exists() },
                { assert path("${outputDir}/results/wasp_filtered/SAMPLE2.filter_stats.txt").exists() },
                { assert path("${outputDir}/results/counts/SAMPLE2_counts.tsv").exists() },
                { assert path("${outputDir}/results/analysis/SAMPLE2_ai_results.tsv").exists() },

                // Header validation (first line must match exactly)
                { assert path("${outputDir}/results/counts/SAMPLE1_counts.tsv").readLines()[0] == countsHeader },
                { assert path("${outputDir}/results/counts/SAMPLE2_counts.tsv").readLines()[0] == countsHeader },
                { assert path("${outputDir}/results/analysis/SAMPLE1_ai_results.tsv").readLines()[0] == aiResultsHeader },
                { assert path("${outputDir}/results/analysis/SAMPLE2_ai_results.tsv").readLines()[0] == aiResultsHeader }
            )
        }
    }

    test("RNASEQ_ASE - fails without input samplesheet") {

        options "-stub -profile test_stub"

        when {
            params {
                vcf        = "${projectDir}/tests/data/test_snps.vcf.gz"
                star_index = "${projectDir}/tests/data/star_index"
                gtf        = "${projectDir}/tests/data/test.gtf"
                outdir     = "${outputDir}/results_no_input"
            }
        }

        then {
            assert workflow.failed
            assert workflow.exitStatus == 1
            assert workflow.stdout.toString().contains("ERROR: --input samplesheet not specified")
        }
    }

    test("RNASEQ_ASE - fails without VCF") {

        options "-stub -profile test_stub"

        when {
            params {
                input      = "${projectDir}/assets/samplesheet_test.csv"
                star_index = "${projectDir}/tests/data/star_index"
                gtf        = "${projectDir}/tests/data/test.gtf"
                outdir     = "${outputDir}/results_no_vcf"
            }
        }

        then {
            assert workflow.failed
            assert workflow.exitStatus == 1
            assert workflow.stdout.toString().contains("ERROR: --vcf variants file not specified")
        }
    }

    test("RNASEQ_ASE - fails without STAR index") {

        options "-stub -profile test_stub"

        when {
            params {
                input      = "${projectDir}/assets/samplesheet_test.csv"
                vcf        = "${projectDir}/tests/data/test_snps.vcf.gz"
                gtf        = "${projectDir}/tests/data/test.gtf"
                outdir     = "${outputDir}/results_no_star"
            }
        }

        then {
            assert workflow.failed
            assert workflow.exitStatus == 1
            assert workflow.stdout.toString().contains("ERROR: --star_index STAR index not specified")
        }
    }

    test("RNASEQ_ASE - fails without VCF index") {

        options "-stub -profile test_stub"

        when {
            params {
                input      = "${projectDir}/assets/samplesheet_test.csv"
                vcf        = "${projectDir}/tests/data/test_snps_no_index.vcf.gz"
                star_index = "${projectDir}/tests/data/star_index"
                gtf        = "${projectDir}/tests/data/test.gtf"
                outdir     = "${outputDir}/results_no_vcf_index"
            }
        }

        then {
            assert workflow.failed
            assert workflow.exitStatus == 1
            assert workflow.stdout.toString().contains("ERROR: VCF index not found")
        }
    }

    test("RNASEQ_ASE - fails with malformed samplesheet - missing sample column") {

        options "-stub -profile test_stub"

        when {
            params {
                input      = "${projectDir}/tests/data/samplesheet_missing_sample.csv"
                vcf        = "${projectDir}/tests/data/test_snps.vcf.gz"
                star_index = "${projectDir}/tests/data/star_index"
                gtf        = "${projectDir}/tests/data/test.gtf"
                outdir     = "${outputDir}/results_bad_samplesheet"
            }
        }

        then {
            assert workflow.failed
            assert workflow.exitStatus == 1
            assert workflow.stdout.toString().contains("ERROR: Samplesheet missing 'sample' column")
        }
    }

    test("RNASEQ_ASE - fails with malformed samplesheet - missing fastq_1 column") {

        options "-stub -profile test_stub"

        when {
            params {
                input      = "${projectDir}/tests/data/samplesheet_missing_fastq.csv"
                vcf        = "${projectDir}/tests/data/test_snps.vcf.gz"
                star_index = "${projectDir}/tests/data/star_index"
                gtf        = "${projectDir}/tests/data/test.gtf"
                outdir     = "${outputDir}/results_bad_samplesheet_fastq"
            }
        }

        then {
            assert workflow.failed
            assert workflow.exitStatus == 1
            assert workflow.stdout.toString().contains("ERROR: Samplesheet missing 'fastq_1'")
        }
    }

    test("RNASEQ_ASE - stub run - single sample") {

        options "-stub -profile test_stub"

        when {
            params {
                input      = "${projectDir}/tests/data/samplesheet_single.csv"
                vcf        = "${projectDir}/tests/data/test_snps.vcf.gz"
                star_index = "${projectDir}/tests/data/star_index"
                gtf        = "${projectDir}/tests/data/test.gtf"
                outdir     = "${outputDir}/results_single"
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert workflow.out.wasp_bam.size() == 1, "Expected 1 WASP BAM output" },
                { assert workflow.out.counts.size() == 1, "Expected 1 counts output" },
                { assert workflow.out.results.size() == 1, "Expected 1 AI results output" },

                // Output directories exist
                { assert path("${outputDir}/results_single/wasp_filtered").exists() },
                { assert path("${outputDir}/results_single/counts").exists() },
                { assert path("${outputDir}/results_single/analysis").exists() },

                // SAMPLE1 outputs (including BAI validation)
                { assert path("${outputDir}/results_single/wasp_filtered/SAMPLE1_wasp_filt.bam").exists() },
                { assert path("${outputDir}/results_single/wasp_filtered/SAMPLE1_wasp_filt.bam.bai").exists() },
                { assert path("${outputDir}/results_single/wasp_filtered/SAMPLE1.filter_stats.txt").exists() },
                { assert path("${outputDir}/results_single/counts/SAMPLE1_counts.tsv").exists() },
                { assert path("${outputDir}/results_single/analysis/SAMPLE1_ai_results.tsv").exists() },

                // Header validation
                { assert path("${outputDir}/results_single/counts/SAMPLE1_counts.tsv").readLines()[0] == countsHeader },
                { assert path("${outputDir}/results_single/analysis/SAMPLE1_ai_results.tsv").readLines()[0] == aiResultsHeader }
            )
        }
    }

    test("RNASEQ_ASE - stub run - single-end sequencing") {

        options "-stub -profile test_stub"

        when {
            params {
                input      = "${projectDir}/tests/data/samplesheet_singleend.csv"
                vcf        = "${projectDir}/tests/data/test_snps.vcf.gz"
                star_index = "${projectDir}/tests/data/star_index"
                gtf        = "${projectDir}/tests/data/test.gtf"
                outdir     = "${outputDir}/results_singleend"
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert workflow.out.wasp_bam.size() == 1, "Expected 1 WASP BAM output" },
                { assert workflow.out.counts.size() == 1, "Expected 1 counts output" },
                { assert workflow.out.results.size() == 1, "Expected 1 AI results output" },

                // Output directories exist
                { assert path("${outputDir}/results_singleend/wasp_filtered").exists() },
                { assert path("${outputDir}/results_singleend/counts").exists() },
                { assert path("${outputDir}/results_singleend/analysis").exists() },

                // Single-end sample outputs
                { assert path("${outputDir}/results_singleend/wasp_filtered/SAMPLE_SE_wasp_filt.bam").exists() },
                { assert path("${outputDir}/results_singleend/wasp_filtered/SAMPLE_SE_wasp_filt.bam.bai").exists() },
                { assert path("${outputDir}/results_singleend/counts/SAMPLE_SE_counts.tsv").exists() },
                { assert path("${outputDir}/results_singleend/analysis/SAMPLE_SE_ai_results.tsv").exists() },

                // Header validation
                { assert path("${outputDir}/results_singleend/counts/SAMPLE_SE_counts.tsv").readLines()[0] == countsHeader },
                { assert path("${outputDir}/results_singleend/analysis/SAMPLE_SE_ai_results.tsv").readLines()[0] == aiResultsHeader }
            )
        }
    }

    test("RNASEQ_ASE - stub run - without GTF annotation") {

        options "-stub -profile test_stub"

        when {
            params {
                input      = "${projectDir}/assets/samplesheet_test.csv"
                vcf        = "${projectDir}/tests/data/test_snps.vcf.gz"
                star_index = "${projectDir}/tests/data/star_index"
                outdir     = "${outputDir}/results_no_gtf"
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert workflow.out.wasp_bam.size() == 2, "Expected 2 WASP BAM outputs" },
                { assert workflow.out.counts.size() == 2, "Expected 2 counts outputs" },
                { assert workflow.out.results.size() == 2, "Expected 2 AI results outputs" },

                // Output files exist
                { assert path("${outputDir}/results_no_gtf/wasp_filtered/SAMPLE1_wasp_filt.bam").exists() },
                { assert path("${outputDir}/results_no_gtf/wasp_filtered/SAMPLE1_wasp_filt.bam.bai").exists() },
                { assert path("${outputDir}/results_no_gtf/wasp_filtered/SAMPLE1.filter_stats.txt").exists() },
                { assert path("${outputDir}/results_no_gtf/wasp_filtered/SAMPLE2_wasp_filt.bam").exists() },
                { assert path("${outputDir}/results_no_gtf/wasp_filtered/SAMPLE2_wasp_filt.bam.bai").exists() },
                { assert path("${outputDir}/results_no_gtf/wasp_filtered/SAMPLE2.filter_stats.txt").exists() },
                { assert path("${outputDir}/results_no_gtf/counts/SAMPLE1_counts.tsv").exists() },
                { assert path("${outputDir}/results_no_gtf/counts/SAMPLE2_counts.tsv").exists() },
                { assert path("${outputDir}/results_no_gtf/analysis/SAMPLE1_ai_results.tsv").exists() },
                { assert path("${outputDir}/results_no_gtf/analysis/SAMPLE2_ai_results.tsv").exists() },

                // Header validation
                { assert path("${outputDir}/results_no_gtf/counts/SAMPLE1_counts.tsv").readLines()[0] == countsHeader },
                { assert path("${outputDir}/results_no_gtf/counts/SAMPLE2_counts.tsv").readLines()[0] == countsHeader },
                { assert path("${outputDir}/results_no_gtf/analysis/SAMPLE1_ai_results.tsv").readLines()[0] == aiResultsHeader },
                { assert path("${outputDir}/results_no_gtf/analysis/SAMPLE2_ai_results.tsv").readLines()[0] == aiResultsHeader }
            )
        }
    }
}

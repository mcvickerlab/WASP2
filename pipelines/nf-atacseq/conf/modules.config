/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    nf-atacseq modules config
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Per-module parameter configurations
----------------------------------------------------------------------------------------
*/

process {
    //
    // QC & Trimming
    //
    withName: 'FASTQC' {
        ext.args = '--quiet'
        publishDir = [
            path: { "${params.outdir}/fastqc" },
            mode: params.publish_dir_mode,
            pattern: '*.{html,zip}'
        ]
    }

    withName: 'FASTP' {
        ext.args = [
            '--qualified_quality_phred 20',
            '--unqualified_percent_limit 40',
            '--length_required 25',
            '--detect_adapter_for_pe'
        ].join(' ')
        publishDir = [
            [
                path: { "${params.outdir}/fastp" },
                mode: params.publish_dir_mode,
                pattern: '*.{json,html}'
            ],
            [
                path: { "${params.outdir}/fastp/log" },
                mode: params.publish_dir_mode,
                pattern: '*.log'
            ]
        ]
    }

    //
    // Alignment
    //
    withName: 'BWA_MEM' {
        ext.args = '-M'
        ext.args2 = '-bhS'
        publishDir = [
            path: { "${params.outdir}/alignment" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename },
            enabled: false
        ]
    }

    withName: 'BOWTIE2_ALIGN' {
        ext.args = '--very-sensitive --no-mixed --no-discordant -X 1000'
        publishDir = [
            path: { "${params.outdir}/alignment" },
            mode: params.publish_dir_mode,
            enabled: false
        ]
    }

    withName: 'SAMTOOLS_INDEX' {
        publishDir = [
            path: { "${params.outdir}/alignment" },
            mode: params.publish_dir_mode,
            pattern: '*.bai',
            enabled: false
        ]
    }

    withName: 'SAMTOOLS_STATS' {
        ext.prefix = { "${meta.id}" }
        publishDir = [
            path: { "${params.outdir}/alignment/stats" },
            mode: params.publish_dir_mode,
            pattern: '*.stats'
        ]
    }

    withName: 'SAMTOOLS_FLAGSTAT' {
        ext.prefix = { "${meta.id}" }
        publishDir = [
            path: { "${params.outdir}/alignment/stats" },
            mode: params.publish_dir_mode,
            pattern: '*.flagstat'
        ]
    }

    withName: 'SAMTOOLS_IDXSTATS' {
        ext.prefix = { "${meta.id}" }
        publishDir = [
            path: { "${params.outdir}/alignment/stats" },
            mode: params.publish_dir_mode,
            pattern: '*.idxstats'
        ]
    }

    //
    // Deduplication
    //
    withName: 'PICARD_MARKDUPLICATES' {
        ext.args = '--REMOVE_DUPLICATES false --VALIDATION_STRINGENCY LENIENT'
        ext.prefix = { "${meta.id}.markdup" }
        publishDir = [
            [
                path: { "${params.outdir}/alignment" },
                mode: params.publish_dir_mode,
                pattern: '*.bam'
            ],
            [
                path: { "${params.outdir}/alignment/picard_metrics" },
                mode: params.publish_dir_mode,
                pattern: '*.txt'
            ]
        ]
    }

    //
    // Peak Calling
    //
    withName: 'MACS2_CALLPEAK' {
        ext.args = [
            '--nomodel',
            '--shift -75',
            '--extsize 150',
            '--keep-dup all',
            '-q 0.01',
            '--call-summits'
        ].join(' ')
        publishDir = [
            path: { "${params.outdir}/peaks" },
            mode: params.publish_dir_mode
        ]
    }

    //
    // WASP2 Modules
    //
    withName: 'WASP2_MAKE_READS' {
        ext.args = { params.wasp_include_indels ? '--indels' : '--snps-only' }
        publishDir = [
            path: { "${params.outdir}/wasp2/remap" },
            mode: params.publish_dir_mode,
            pattern: '*_wasp_data_files.json',
            enabled: true
        ]
    }

    withName: 'WASP2_FILTER_REMAPPED' {
        ext.args = { "--threads ${params.wasp_threads}" }
        publishDir = [
            [
                path: { "${params.outdir}/wasp2/filtered" },
                mode: params.publish_dir_mode,
                pattern: '*.bam*'
            ],
            [
                path: { "${params.outdir}/wasp2/filtered" },
                mode: params.publish_dir_mode,
                pattern: '*_wasp_stats.txt'
            ]
        ]
    }

    withName: 'WASP2_COUNT_VARIANTS' {
        ext.args = ''  // WASP2 auto-detects Rust availability
        publishDir = [
            path: { "${params.outdir}/counts" },
            mode: params.publish_dir_mode,
            pattern: '*_counts.tsv'
        ]
    }

    withName: 'WASP2_FIND_IMBALANCE' {
        ext.args = { params.wasp_phased ? '--phased' : '' }
        publishDir = [
            path: { "${params.outdir}/analysis" },
            mode: params.publish_dir_mode,
            pattern: '*_ai_results.tsv'
        ]
    }

    //
    // Reporting
    //
    withName: 'MULTIQC' {
        ext.args = '--verbose'
        publishDir = [
            path: { "${params.outdir}/multiqc" },
            mode: params.publish_dir_mode
        ]
    }
}

/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    nf-outrider Modules Config
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Module-specific configuration options
----------------------------------------------------------------------------------------
*/

process {
    // Default publishing options
    publishDir = [
        path: { "${params.outdir}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}" },
        mode: params.publish_dir_mode,
        saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
    ]

    // WASP2 modules
    withName: 'WASP2_FILTER_REMAPPED' {
        publishDir = [
            path: { "${params.outdir}/wasp2/filtered_bams" },
            mode: params.publish_dir_mode,
            pattern: "*.bam*"
        ]
        ext.args = ''
    }

    withName: 'WASP2_COUNT' {
        publishDir = [
            path: { "${params.outdir}/wasp2/allele_counts" },
            mode: params.publish_dir_mode,
            pattern: "*.counts.tsv"
        ]
        ext.use_rust = params.wasp_use_rust
    }

    // Gene aggregation
    withName: 'AGGREGATE_COUNTS' {
        publishDir = [
            path: { "${params.outdir}/aggregated" },
            mode: params.publish_dir_mode,
            pattern: "*.tsv"
        ]
    }

    // OUTRIDER modules
    withName: 'OUTRIDER_FIT' {
        label = 'process_high_memory'
        publishDir = [
            path: { "${params.outdir}/outrider" },
            mode: params.publish_dir_mode,
            pattern: "*.{rds,tsv,html}"
        ]
    }

    withName: 'OUTRIDER_RESULTS' {
        publishDir = [
            path: { "${params.outdir}/outrider" },
            mode: params.publish_dir_mode,
            pattern: "*.tsv"
        ]
    }

    // MAE module
    withName: 'MAE_DETECT' {
        publishDir = [
            path: { "${params.outdir}/mae" },
            mode: params.publish_dir_mode,
            pattern: "*.tsv"
        ]
    }

    // MultiQC
    withName: 'MULTIQC' {
        publishDir = [
            path: { "${params.outdir}/multiqc" },
            mode: params.publish_dir_mode,
            pattern: "*.html"
        ]
    }
}

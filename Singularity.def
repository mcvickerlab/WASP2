# WASP2 Singularity Definition File
# Builds a Singularity/Apptainer container from the Docker image
#
# Version: keep in sync with rust/Cargo.toml (single source of truth)
# Run scripts/check-version-consistency.sh to verify
#
# Build: singularity build wasp2.sif Singularity.def
# Or pull directly: singularity pull docker://mcvickerlab/wasp2:latest

Bootstrap: docker
From: mcvickerlab/wasp2:1.3.0

%labels
    Author Jeff Jaureguy <jeffpjaureguy@gmail.com>
    Version 1.3.0
    Description WASP2: Allele-specific analysis of NGS data with Rust acceleration

%help
    WASP2 - Allele-Specific Analysis Pipeline

    This container provides tools for allele-specific analysis of NGS data:

    CLI Tools (each has subcommands - use --help for details):
      wasp2-count    - Allele counting (count-variants, count-variants-sc)
      wasp2-map      - WASP mapping filter (make-reads, filter-remapped)
      wasp2-analyze  - Statistical analysis (find-imbalance, find-imbalance-sc, compare-imbalance)

    Usage Examples:
      singularity exec wasp2.sif wasp2-count --help
      singularity exec wasp2.sif wasp2-map make-reads input.bam variants.vcf.gz
      singularity exec wasp2.sif wasp2-analyze find-imbalance counts.tsv -o results.tsv

    Nextflow Integration:
      nextflow run main.nf -profile singularity

    Documentation: https://github.com/mcvickerlab/WASP2

%environment
    export LC_ALL=C
    export PATH="/app/.venv/bin:/usr/local/bin:$PATH"

%runscript
    exec "$@"

%test
    wasp2-count --version
    wasp2-map --version
    wasp2-analyze --version
    python -c "import wasp2_rust; print('Rust extension OK')"

    # Data smoke test (if test data bundled in container)
    if [ -f /opt/wasp2/test-data/sample1.bam ]; then
        echo "Running data smoke test..."
        wasp2-count count-variants \
            /opt/wasp2/test-data/sample1.bam \
            /opt/wasp2/test-data/variants.vcf.gz \
            --samples SAMPLE1 \
            --out /tmp/test_counts.tsv
        if [ -s /tmp/test_counts.tsv ]; then
            echo "Data smoke test PASSED"
        else
            echo "Data smoke test FAILED"
            exit 1
        fi
        rm -f /tmp/test_counts.tsv
    fi

    echo "All tests passed!"

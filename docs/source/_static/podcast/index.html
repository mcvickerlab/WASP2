<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The WASP's Nest - Podcast</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,opsz,wght@0,6..96,400;0,6..96,700;1,6..96,400&family=JetBrains+Mono:wght@400;600&family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <style>
        :root {
            --amber-glow: #F5A623;
            --amber-bright: #FFB938;
            --amber-dim: #8B5A00;
            --amber-deep: #5C3D00;
            --hive-void: #0a0a0f;
            --hive-dark: #12121a;
            --hive-surface: #1a1a26;
            --hive-cell: #222233;
            --text-bright: #f4f0e8;
            --text-soft: #a8a4a0;
            --text-dim: #6b6860;
            --glow-subtle: rgba(245, 166, 35, 0.15);
            --glow-medium: rgba(245, 166, 35, 0.35);
            --glow-intense: rgba(245, 166, 35, 0.6);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.6; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 1; }
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px var(--glow-subtle), inset 0 0 20px var(--glow-subtle); }
            50% { box-shadow: 0 0 40px var(--glow-medium), inset 0 0 30px var(--glow-subtle); }
        }

        @keyframes shimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }

        @keyframes fadeSlideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes waveform {
            0%, 100% { height: 4px; }
            50% { height: 24px; }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--hive-void);
            color: var(--text-bright);
            line-height: 1.7;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Honeycomb background pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(245, 166, 35, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(245, 166, 35, 0.05) 0%, transparent 50%),
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='56' height='100' viewBox='0 0 56 100'%3E%3Cpath d='M28 66L0 50L0 16L28 0L56 16L56 50L28 66Z' fill='none' stroke='rgba(245,166,35,0.06)' stroke-width='1'/%3E%3Cpath d='M28 100L0 84L0 50L28 34L56 50L56 84L28 100Z' fill='none' stroke='rgba(245,166,35,0.06)' stroke-width='1'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 0;
        }

        /* Floating particles */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--amber-glow);
            border-radius: 50%;
            animation: float 8s ease-in-out infinite;
            filter: blur(1px);
        }

        .header {
            position: relative;
            z-index: 10;
            padding: 4rem 2rem 3rem;
            text-align: center;
            background: linear-gradient(180deg, var(--hive-dark) 0%, transparent 100%);
        }

        .logo-container {
            position: relative;
            display: inline-block;
            margin-bottom: 1.5rem;
        }

        .logo {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 3px solid var(--amber-glow);
            animation: pulse-glow 4s ease-in-out infinite;
            position: relative;
            z-index: 2;
        }

        .logo-ring {
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border: 1px solid var(--amber-dim);
            border-radius: 50%;
            animation: pulse-glow 4s ease-in-out infinite 0.5s;
        }

        .header h1 {
            font-family: 'Bodoni Moda', serif;
            font-size: clamp(2.5rem, 6vw, 4rem);
            font-weight: 700;
            color: var(--text-bright);
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 40px var(--glow-medium);
        }

        .header h1 span {
            color: var(--amber-glow);
        }

        .tagline {
            font-family: 'Bodoni Moda', serif;
            font-style: italic;
            font-size: 1.2rem;
            color: var(--text-soft);
            letter-spacing: 0.15em;
            text-transform: uppercase;
        }

        .container {
            position: relative;
            z-index: 10;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .series-banner {
            background: linear-gradient(135deg, var(--hive-surface) 0%, var(--hive-cell) 100%);
            border-radius: 2px;
            padding: 2.5rem 3rem;
            margin-bottom: 4rem;
            position: relative;
            overflow: hidden;
            animation: fadeSlideUp 0.8s ease-out;
        }

        .series-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--amber-glow), transparent);
        }

        .series-banner::after {
            content: 'THE WASP CHRONICLES';
            position: absolute;
            top: 1rem;
            right: 2rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            letter-spacing: 0.3em;
            color: var(--amber-dim);
        }

        .series-banner h2 {
            font-family: 'Outfit', sans-serif;
            font-weight: 800;
            font-size: 1.8rem;
            color: var(--amber-glow);
            margin-bottom: 1rem;
            letter-spacing: 0.02em;
        }

        .series-banner p {
            color: var(--text-soft);
            max-width: 700px;
            font-weight: 300;
        }

        /* Hexagonal episode grid */
        .episode-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 4rem;
            perspective: 1000px;
        }

        .episode-card {
            width: 380px;
            background: var(--hive-surface);
            position: relative;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            padding: 3rem 2rem;
            text-align: center;
            animation: fadeSlideUp 0.8s ease-out backwards;
        }

        .episode-card:nth-child(1) { animation-delay: 0.1s; }
        .episode-card:nth-child(2) { animation-delay: 0.2s; }
        .episode-card:nth-child(3) { animation-delay: 0.3s; }

        .episode-card::before {
            content: '';
            position: absolute;
            inset: 2px;
            background: var(--hive-dark);
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            z-index: -1;
        }

        .episode-card:hover {
            transform: translateY(-10px) scale(1.02);
            background: linear-gradient(135deg, var(--amber-glow), var(--amber-bright));
            box-shadow: 0 20px 60px var(--glow-medium);
        }

        .episode-card.active {
            background: linear-gradient(135deg, var(--amber-glow), var(--amber-bright));
            box-shadow: 0 0 60px var(--glow-intense);
        }

        .episode-number {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            letter-spacing: 0.3em;
            color: var(--amber-glow);
            margin-bottom: 1rem;
            transition: color 0.3s;
        }

        .episode-card:hover .episode-number,
        .episode-card.active .episode-number {
            color: var(--hive-dark);
        }

        .episode-title {
            font-family: 'Bodoni Moda', serif;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            transition: color 0.3s;
        }

        .episode-card:hover .episode-title,
        .episode-card.active .episode-title {
            color: var(--hive-dark);
        }

        .episode-subtitle {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 1.5rem;
            transition: color 0.3s;
        }

        .episode-card:hover .episode-subtitle,
        .episode-card.active .episode-subtitle {
            color: var(--hive-surface);
        }

        .episode-description {
            font-size: 0.9rem;
            color: var(--text-soft);
            line-height: 1.6;
            margin-bottom: 1.5rem;
            transition: color 0.3s;
        }

        .episode-card:hover .episode-description,
        .episode-card.active .episode-description {
            color: var(--hive-dark);
        }

        .episode-topics {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.4rem;
            margin-bottom: 1rem;
        }

        .topic-tag {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            padding: 0.3rem 0.7rem;
            background: var(--glow-subtle);
            color: var(--amber-glow);
            border-radius: 2px;
            letter-spacing: 0.05em;
            transition: all 0.3s;
        }

        .episode-card:hover .topic-tag,
        .episode-card.active .topic-tag {
            background: rgba(0,0,0,0.2);
            color: var(--hive-dark);
        }

        .episode-duration {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-dim);
            transition: color 0.3s;
        }

        .episode-card:hover .episode-duration,
        .episode-card.active .episode-duration {
            color: var(--hive-surface);
        }

        /* Content Viewer */
        .content-viewer {
            background: var(--hive-dark);
            border: 1px solid var(--hive-cell);
            border-radius: 4px;
            padding: 0;
            margin-top: 2rem;
            display: none;
            overflow: hidden;
            animation: fadeSlideUp 0.5s ease-out;
        }

        .content-viewer.visible {
            display: block;
        }

        .viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            background: var(--hive-surface);
            border-bottom: 1px solid var(--hive-cell);
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .nav-tab {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            background: transparent;
            color: var(--text-dim);
            border: 1px solid var(--hive-cell);
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-tab:hover {
            color: var(--amber-glow);
            border-color: var(--amber-dim);
        }

        .nav-tab.active {
            background: var(--amber-glow);
            color: var(--hive-dark);
            border-color: var(--amber-glow);
        }

        .close-btn {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            letter-spacing: 0.1em;
            background: transparent;
            color: var(--text-dim);
            border: 1px solid var(--hive-cell);
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .close-btn:hover {
            color: var(--text-bright);
            border-color: var(--text-dim);
        }

        #contentArea {
            padding: 2.5rem;
            min-height: 300px;
        }

        /* Audio Player */
        .audio-player {
            background: linear-gradient(135deg, var(--hive-surface) 0%, var(--hive-cell) 100%);
            border-radius: 4px;
            padding: 3rem;
            position: relative;
            overflow: hidden;
        }

        .audio-player::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='56' height='100' viewBox='0 0 56 100'%3E%3Cpath d='M28 66L0 50L0 16L28 0L56 16L56 50L28 66Z' fill='none' stroke='rgba(245,166,35,0.08)' stroke-width='1'/%3E%3Cpath d='M28 100L0 84L0 50L28 34L56 50L56 84L28 100Z' fill='none' stroke='rgba(245,166,35,0.08)' stroke-width='1'/%3E%3C/svg%3E");
            opacity: 0.5;
        }

        .audio-player-inner {
            position: relative;
            z-index: 1;
        }

        .audio-player h3 {
            font-family: 'Bodoni Moda', serif;
            font-size: 1.8rem;
            color: var(--text-bright);
            margin-bottom: 0.5rem;
        }

        .audio-player h3 span {
            color: var(--amber-glow);
        }

        .audio-subtitle {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            letter-spacing: 0.2em;
            color: var(--amber-dim);
            margin-bottom: 2rem;
        }

        /* Custom Audio Controls */
        .custom-audio-player {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 1.5rem 2rem;
            background: var(--hive-dark);
            border: 1px solid var(--hive-cell);
            border-radius: 4px;
            margin-bottom: 2rem;
        }

        .play-pause-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--amber-glow);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .play-pause-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px var(--glow-medium);
        }

        .play-pause-btn svg {
            width: 24px;
            height: 24px;
            fill: var(--hive-dark);
        }

        .audio-info {
            flex: 1;
            min-width: 0;
        }

        .audio-progress {
            width: 100%;
            height: 4px;
            background: var(--hive-cell);
            border-radius: 2px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .audio-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--amber-glow), var(--amber-bright));
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .audio-time {
            display: flex;
            justify-content: space-between;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        /* Waveform visualization */
        .waveform {
            display: flex;
            align-items: center;
            gap: 3px;
            height: 40px;
            margin-left: auto;
            padding-left: 1.5rem;
        }

        .waveform-bar {
            width: 3px;
            background: var(--amber-glow);
            border-radius: 2px;
            opacity: 0.4;
            transition: opacity 0.2s;
        }

        .waveform-bar.active {
            opacity: 1;
            animation: waveform 0.5s ease-in-out infinite;
        }

        .audio-description {
            font-size: 0.95rem;
            color: var(--text-soft);
            line-height: 1.8;
            max-width: 600px;
        }

        /* Content viewer typography */
        .content-viewer h1 {
            font-family: 'Bodoni Moda', serif;
            font-size: 2.2rem;
            color: var(--amber-glow);
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--hive-cell);
        }

        .content-viewer h2 {
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            font-size: 1.4rem;
            color: var(--amber-glow);
            margin: 2.5rem 0 1rem;
            letter-spacing: 0.02em;
        }

        .content-viewer h3 {
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--amber-bright);
            margin: 1.5rem 0 0.75rem;
        }

        .content-viewer p {
            margin-bottom: 1.2rem;
            color: var(--text-soft);
        }

        .content-viewer code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85em;
            background: var(--hive-cell);
            padding: 0.2rem 0.5rem;
            border-radius: 2px;
            color: var(--amber-bright);
        }

        .content-viewer pre {
            background: var(--hive-void);
            border: 1px solid var(--hive-cell);
            padding: 1.5rem;
            border-radius: 4px;
            overflow-x: auto;
            margin: 1.5rem 0;
        }

        .content-viewer pre code {
            background: none;
            padding: 0;
            color: var(--text-bright);
        }

        .content-viewer table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            font-size: 0.9rem;
        }

        .content-viewer th,
        .content-viewer td {
            border: 1px solid var(--hive-cell);
            padding: 0.75rem 1rem;
            text-align: left;
        }

        .content-viewer th {
            background: var(--hive-surface);
            color: var(--amber-glow);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .content-viewer blockquote {
            border-left: 3px solid var(--amber-glow);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--hive-surface);
            color: var(--text-soft);
            font-style: italic;
        }

        .content-viewer hr {
            border: none;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--hive-cell), transparent);
            margin: 3rem 0;
        }

        .content-viewer .mermaid {
            background: var(--hive-void);
            border: 1px solid var(--hive-cell);
            padding: 2rem;
            border-radius: 4px;
            margin: 2rem 0;
            overflow-x: auto;
        }

        /* Footer */
        .footer {
            position: relative;
            z-index: 10;
            text-align: center;
            padding: 4rem 2rem;
            margin-top: 4rem;
            border-top: 1px solid var(--hive-cell);
        }

        .footer-tagline {
            font-family: 'Bodoni Moda', serif;
            font-style: italic;
            font-size: 1.2rem;
            color: var(--text-soft);
            margin-bottom: 1rem;
        }

        .footer-meta {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            letter-spacing: 0.2em;
            color: var(--text-dim);
        }

        .footer a {
            color: var(--amber-glow);
            text-decoration: none;
            transition: color 0.3s;
        }

        .footer a:hover {
            color: var(--amber-bright);
        }

        /* Responsive */
        @media (max-width: 900px) {
            .episode-card {
                width: 320px;
            }
        }

        @media (max-width: 768px) {
            .episode-card {
                width: 100%;
                max-width: 380px;
                clip-path: none;
                border-radius: 4px;
                padding: 2rem;
            }

            .episode-card::before {
                clip-path: none;
                border-radius: 4px;
            }

            .custom-audio-player {
                flex-wrap: wrap;
            }

            .waveform {
                display: none;
            }

            .viewer-header {
                flex-direction: column;
                gap: 1rem;
            }

            .nav-tabs {
                width: 100%;
                justify-content: center;
            }
        }

        /* Hidden native audio */
        audio {
            display: none;
        }

        /* ===== ACCESSIBILITY FIXES ===== */

        /* Focus indicators (WCAG 2.1) */
        .play-pause-btn:focus-visible,
        .skip-btn:focus-visible,
        .mute-btn:focus-visible,
        .nav-tab:focus-visible,
        .close-btn:focus-visible,
        .episode-card:focus-visible,
        .speed-select:focus-visible,
        .download-btn:focus-visible {
            outline: 3px solid var(--amber-glow);
            outline-offset: 3px;
        }

        .audio-progress:focus-visible {
            outline: 3px solid var(--amber-glow);
            outline-offset: 2px;
        }

        .volume-slider:focus-visible {
            outline: 2px solid var(--amber-glow);
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            .particle,
            .waveform-bar {
                animation: none !important;
            }
            .logo {
                animation: none;
            }
            * {
                transition-duration: 0.01ms !important;
            }
        }

        /* ===== NEW AUDIO CONTROLS ===== */

        .audio-controls-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .skip-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--hive-cell);
            border: 1px solid var(--hive-surface);
            color: var(--text-soft);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .skip-btn:hover {
            background: var(--amber-dim);
            color: var(--text-bright);
            border-color: var(--amber-glow);
        }

        .skip-btn svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        /* Volume control */
        .volume-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: auto;
            padding-left: 1rem;
        }

        .mute-btn {
            width: 36px;
            height: 36px;
            border-radius: 4px;
            background: transparent;
            border: 1px solid var(--hive-cell);
            color: var(--text-soft);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .mute-btn:hover {
            color: var(--amber-glow);
            border-color: var(--amber-dim);
        }

        .mute-btn.muted {
            color: var(--text-dim);
        }

        .mute-btn svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .volume-slider {
            width: 80px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--hive-cell);
            border-radius: 2px;
            cursor: pointer;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--amber-glow);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .volume-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: var(--amber-glow);
            border-radius: 50%;
            border: none;
            cursor: pointer;
        }

        /* Speed control */
        .speed-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .speed-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            color: var(--text-dim);
            letter-spacing: 0.1em;
        }

        .speed-select {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            background: var(--hive-cell);
            color: var(--text-soft);
            border: 1px solid var(--hive-surface);
            border-radius: 4px;
            padding: 0.4rem 0.6rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .speed-select:hover {
            border-color: var(--amber-dim);
            color: var(--text-bright);
        }

        /* Download button */
        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            letter-spacing: 0.1em;
            background: transparent;
            color: var(--amber-glow);
            border: 1px solid var(--amber-dim);
            padding: 0.6rem 1rem;
            border-radius: 4px;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 1rem;
        }

        .download-btn:hover {
            background: var(--amber-glow);
            color: var(--hive-dark);
        }

        .download-btn svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        /* Loading state */
        .audio-player.loading .play-pause-btn {
            opacity: 0.6;
            pointer-events: none;
        }

        .audio-player.loading .play-pause-btn::after {
            content: '';
            position: absolute;
            width: 60px;
            height: 60px;
            border: 3px solid transparent;
            border-top-color: var(--hive-dark);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error state */
        .audio-error {
            background: rgba(255, 100, 100, 0.1);
            border: 1px solid rgba(255, 100, 100, 0.3);
            color: #ff6b6b;
            padding: 1rem 1.5rem;
            border-radius: 4px;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .audio-error::before {
            content: '⚠ ';
        }

        /* Secondary controls row */
        .audio-secondary-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--hive-cell);
        }

        /* Progress bar improvements */
        .audio-progress {
            position: relative;
        }

        .audio-progress-handle {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 14px;
            height: 14px;
            background: var(--amber-bright);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .audio-progress:hover .audio-progress-handle,
        .audio-progress:focus .audio-progress-handle {
            opacity: 1;
        }

        /* Transcript styles */
        .transcript-content {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 1rem;
        }

        .transcript-content p {
            margin-bottom: 1rem;
            line-height: 1.8;
        }

        /* Improved text-dim for better contrast */
        .episode-duration,
        .audio-time,
        .speed-label {
            color: #8b8880; /* Improved contrast */
        }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>

    <header class="header">
        <div class="logo-container">
            <div class="logo-ring"></div>
            <img src="artwork/wasp2_logo.png" alt="WASP2 Logo" class="logo" onerror="this.style.display='none'">
        </div>
        <h1>The <span>WASP's</span> Nest</h1>
        <p class="tagline">Buzz from the Hive</p>
    </header>

    <div class="container">
        <div class="series-banner">
            <h2>A Three-Part Chronicle</h2>
            <p>Tracing the evolution of WASP from its origins in 2015 to the modern Rust-accelerated implementation. Perfect for understanding the project's history, design philosophy, and the science behind allele-specific analysis.</p>
        </div>

        <div class="episode-grid" id="episodeGrid"></div>

        <div class="content-viewer" id="contentViewer">
            <div class="viewer-header">
                <div class="nav-tabs" id="navTabs"></div>
                <button class="close-btn" id="closeBtn">CLOSE</button>
            </div>
            <div id="contentArea"></div>
        </div>
    </div>

    <footer class="footer">
        <p class="footer-tagline">Keep building, keep buzzing. Buzz out.</p>
        <p class="footer-meta">WASP2 v1.3.0 &nbsp;|&nbsp; <a href="https://github.com/Jaureguy760/WASP2-final">GITHUB</a></p>
    </footer>

    <script>
        // Episode data
        const episodes = [
            {
                number: 1,
                title: "The Origin Swarm",
                subtitle: "Original WASP (2015)",
                description: "The story of the original WASP published in Nature Methods 2015. Learn how van de Geijn, McVicker, Gilad, and Pritchard solved the mapping bias problem.",
                duration: "8-10 minutes",
                topics: ["mapping bias", "allele swapping", "Combined Haplotype Test", "HDF5"],
                chronicleFile: "chronicles/episode-001-origin-swarm.md",
                illuminationFile: "illuminations/illumination-001-wasp-mapping.md",
                audioFile: "audio/episode-001-origin-swarm.mp3"
            },
            {
                number: 2,
                title: "Building the New Hive",
                subtitle: "McVicker Lab WASP2",
                description: "How the McVicker Lab rebuilt WASP for the modern era. No more HDF5 conversion, unified CLI, single-cell support.",
                duration: "8-10 minutes",
                topics: ["modernization", "VCF/BCF native", "Typer CLI", "AnnData"],
                chronicleFile: "chronicles/episode-002-new-hive.md",
                illuminationFile: "illuminations/illumination-002-architecture.md",
                audioFile: "audio/episode-002-new-hive.mp3"
            },
            {
                number: 3,
                title: "The Rust Metamorphosis",
                subtitle: "High Performance & Deployment",
                description: "The transformation to Rust-accelerated performance. 50-100x speedups, full INDEL support, Nextflow pipelines, Docker and Singularity containers.",
                duration: "12-15 minutes",
                topics: ["Rust", "INDEL support", "Nextflow", "Docker", "PyPI"],
                chronicleFile: "chronicles/episode-003-rust-metamorphosis.md",
                illuminationFile: "illuminations/illumination-003-performance.md",
                audioFile: "audio/episode-003-rust-metamorphosis.mp3"
            }
        ];

        let currentEpisode = null;
        let audioElement = null;
        let isPlaying = false;

        // Initialize mermaid
        mermaid.initialize({
            startOnLoad: false,
            theme: 'dark',
            themeVariables: {
                primaryColor: '#F5A623',
                primaryTextColor: '#f4f0e8',
                primaryBorderColor: '#F5A623',
                lineColor: '#F5A623',
                secondaryColor: '#222233',
                tertiaryColor: '#1a1a26',
                background: '#12121a',
                mainBkg: '#222233'
            }
        });

        // Create floating particles (respects prefers-reduced-motion)
        function createParticles() {
            // Skip particles if user prefers reduced motion
            if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                return;
            }
            const container = document.getElementById('particles');
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 8 + 's';
                particle.style.animationDuration = (6 + Math.random() * 4) + 's';
                container.appendChild(particle);
            }
        }

        // Create episode card with keyboard accessibility
        function createEpisodeCard(ep) {
            const card = document.createElement('div');
            card.className = 'episode-card';
            card.dataset.episode = ep.number;

            // Accessibility: make focusable and act as button
            card.setAttribute('tabindex', '0');
            card.setAttribute('role', 'button');
            card.setAttribute('aria-label', `Episode ${ep.number}: ${ep.title}. ${ep.subtitle}. ${ep.duration}`);

            const numEl = document.createElement('div');
            numEl.className = 'episode-number';
            numEl.textContent = 'EPISODE ' + String(ep.number).padStart(3, '0');

            const titleEl = document.createElement('h3');
            titleEl.className = 'episode-title';
            titleEl.textContent = ep.title;

            const subtitleEl = document.createElement('div');
            subtitleEl.className = 'episode-subtitle';
            subtitleEl.textContent = ep.subtitle;

            const descEl = document.createElement('p');
            descEl.className = 'episode-description';
            descEl.textContent = ep.description;

            const topicsEl = document.createElement('div');
            topicsEl.className = 'episode-topics';
            topicsEl.setAttribute('aria-label', 'Topics');
            ep.topics.forEach(t => {
                const tag = document.createElement('span');
                tag.className = 'topic-tag';
                tag.textContent = t;
                topicsEl.appendChild(tag);
            });

            const durationEl = document.createElement('time');
            durationEl.className = 'episode-duration';
            durationEl.textContent = ep.duration;
            durationEl.setAttribute('datetime', 'PT' + ep.duration.split('-')[0] + 'M');

            card.appendChild(numEl);
            card.appendChild(titleEl);
            card.appendChild(subtitleEl);
            card.appendChild(descEl);
            card.appendChild(topicsEl);
            card.appendChild(durationEl);

            // Click handler
            card.addEventListener('click', () => loadEpisode(ep.number));

            // Keyboard handler (Enter or Space)
            card.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    loadEpisode(ep.number);
                }
            });

            return card;
        }

        function renderEpisodes() {
            const grid = document.getElementById('episodeGrid');
            grid.replaceChildren();
            episodes.forEach(ep => grid.appendChild(createEpisodeCard(ep)));
        }

        async function loadEpisode(num) {
            const ep = episodes.find(e => e.number === num);
            if (!ep) return;

            currentEpisode = num;
            if (audioElement) {
                audioElement.pause();
                isPlaying = false;
            }

            document.querySelectorAll('.episode-card').forEach(card => {
                card.classList.toggle('active', parseInt(card.dataset.episode) === num);
            });

            const viewer = document.getElementById('contentViewer');
            viewer.classList.add('visible');

            const tabs = document.getElementById('navTabs');
            tabs.replaceChildren();

            ['Listen', 'Transcript', 'Chronicle', 'Illumination'].forEach((name, i) => {
                const tab = document.createElement('button');
                tab.className = 'nav-tab' + (i === 0 ? ' active' : '');
                tab.textContent = name.toUpperCase();
                tab.setAttribute('aria-label', name + ' view');
                tab.addEventListener('click', () => showTab(name.toLowerCase()));
                tabs.appendChild(tab);
            });

            await showTab('listen');
            viewer.scrollIntoView({ behavior: 'smooth' });
        }

        // SVG icon templates (static, trusted content)
        const SVG_PLAY = '<svg aria-hidden="true" viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>';
        const SVG_PAUSE = '<svg aria-hidden="true" viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';
        const SVG_SKIP_BACK = '<svg viewBox="0 0 24 24"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>';
        const SVG_SKIP_FWD = '<svg viewBox="0 0 24 24"><path d="M12 5V1l5 5-5 5V7c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6h2c0 4.42-3.58 8-8 8s-8-3.58-8-8 3.58-8 8-8z"/></svg>';
        const SVG_VOLUME = '<svg aria-hidden="true" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>';
        const SVG_MUTED = '<svg aria-hidden="true" viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>';
        const SVG_DOWNLOAD = '<svg aria-hidden="true" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>';

        async function showTab(type) {
            const ep = episodes.find(e => e.number === currentEpisode);
            if (!ep) return;

            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach((tab, i) => {
                tab.classList.toggle('active',
                    (type === 'listen' && i === 0) ||
                    (type === 'transcript' && i === 1) ||
                    (type === 'chronicle' && i === 2) ||
                    (type === 'illumination' && i === 3)
                );
            });

            const contentArea = document.getElementById('contentArea');

            // ===== LISTEN TAB - Fully Accessible Audio Player =====
            if (type === 'listen') {
                contentArea.replaceChildren();

                const player = document.createElement('div');
                player.className = 'audio-player loading';
                player.setAttribute('role', 'region');
                player.setAttribute('aria-label', 'Audio Player');

                const inner = document.createElement('div');
                inner.className = 'audio-player-inner';

                const title = document.createElement('h3');
                const titleSpan = document.createElement('span');
                titleSpan.textContent = 'Episode ' + String(ep.number).padStart(3, '0') + ': ';
                title.appendChild(titleSpan);
                title.appendChild(document.createTextNode(ep.title));

                const subtitle = document.createElement('div');
                subtitle.className = 'audio-subtitle';
                subtitle.textContent = ep.subtitle.toUpperCase();

                // Custom audio player with full controls
                const customPlayer = document.createElement('div');
                customPlayer.className = 'custom-audio-player';

                // Skip Back button
                const skipBackBtn = document.createElement('button');
                skipBackBtn.className = 'skip-btn';
                skipBackBtn.setAttribute('aria-label', 'Skip back 15 seconds');
                skipBackBtn.textContent = '−15';

                // Play/Pause button with ARIA
                const playBtn = document.createElement('button');
                playBtn.className = 'play-pause-btn';
                playBtn.setAttribute('aria-label', 'Play ' + ep.title);
                playBtn.setAttribute('aria-pressed', 'false');
                playBtn.innerHTML = SVG_PLAY;

                // Skip Forward button
                const skipFwdBtn = document.createElement('button');
                skipFwdBtn.className = 'skip-btn';
                skipFwdBtn.setAttribute('aria-label', 'Skip forward 15 seconds');
                skipFwdBtn.textContent = '+15';

                const audioInfo = document.createElement('div');
                audioInfo.className = 'audio-info';

                // Progress bar with ARIA slider role
                const progress = document.createElement('div');
                progress.className = 'audio-progress';
                progress.setAttribute('role', 'slider');
                progress.setAttribute('tabindex', '0');
                progress.setAttribute('aria-label', 'Seek audio position');
                progress.setAttribute('aria-valuemin', '0');
                progress.setAttribute('aria-valuemax', '100');
                progress.setAttribute('aria-valuenow', '0');
                progress.setAttribute('aria-valuetext', '0 seconds');

                const progressFill = document.createElement('div');
                progressFill.className = 'audio-progress-fill';
                const progressHandle = document.createElement('div');
                progressHandle.className = 'audio-progress-handle';
                progress.appendChild(progressFill);
                progress.appendChild(progressHandle);

                // Time display
                const timeDisplay = document.createElement('div');
                timeDisplay.className = 'audio-time';
                const currentTimeSpan = document.createElement('span');
                currentTimeSpan.className = 'current-time';
                currentTimeSpan.textContent = '0:00';
                const totalTimeSpan = document.createElement('span');
                totalTimeSpan.className = 'total-time';
                totalTimeSpan.textContent = '--:--';
                timeDisplay.appendChild(currentTimeSpan);
                timeDisplay.appendChild(totalTimeSpan);

                audioInfo.appendChild(progress);
                audioInfo.appendChild(timeDisplay);

                // Volume control
                const volumeControl = document.createElement('div');
                volumeControl.className = 'volume-control';

                const muteBtn = document.createElement('button');
                muteBtn.className = 'mute-btn';
                muteBtn.setAttribute('aria-label', 'Mute');
                muteBtn.setAttribute('aria-pressed', 'false');
                muteBtn.innerHTML = SVG_VOLUME;

                const volumeSlider = document.createElement('input');
                volumeSlider.type = 'range';
                volumeSlider.className = 'volume-slider';
                volumeSlider.min = '0';
                volumeSlider.max = '100';
                volumeSlider.value = '80';
                volumeSlider.setAttribute('aria-label', 'Volume');

                volumeControl.appendChild(muteBtn);
                volumeControl.appendChild(volumeSlider);

                // Waveform visualization
                const waveform = document.createElement('div');
                waveform.className = 'waveform';
                waveform.setAttribute('aria-hidden', 'true');
                for (let i = 0; i < 12; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'waveform-bar';
                    bar.style.height = (4 + Math.random() * 20) + 'px';
                    bar.style.animationDelay = (i * 0.1) + 's';
                    waveform.appendChild(bar);
                }

                // Assemble main controls
                customPlayer.appendChild(skipBackBtn);
                customPlayer.appendChild(playBtn);
                customPlayer.appendChild(skipFwdBtn);
                customPlayer.appendChild(audioInfo);
                customPlayer.appendChild(volumeControl);
                customPlayer.appendChild(waveform);

                // Secondary controls row
                const secondaryControls = document.createElement('div');
                secondaryControls.className = 'audio-secondary-controls';

                // Speed control
                const speedControl = document.createElement('div');
                speedControl.className = 'speed-control';
                const speedLabel = document.createElement('span');
                speedLabel.className = 'speed-label';
                speedLabel.textContent = 'SPEED';
                const speedSelect = document.createElement('select');
                speedSelect.className = 'speed-select';
                speedSelect.setAttribute('aria-label', 'Playback speed');
                [0.5, 0.75, 1, 1.25, 1.5, 2].forEach(speed => {
                    const opt = document.createElement('option');
                    opt.value = speed;
                    opt.textContent = speed + 'x';
                    if (speed === 1) opt.selected = true;
                    speedSelect.appendChild(opt);
                });
                speedControl.appendChild(speedLabel);
                speedControl.appendChild(speedSelect);

                // Download button
                const downloadBtn = document.createElement('a');
                downloadBtn.className = 'download-btn';
                downloadBtn.href = ep.audioFile;
                downloadBtn.download = 'WASP-Chronicles-E' + String(ep.number).padStart(2, '0') + '.mp3';
                downloadBtn.setAttribute('aria-label', 'Download episode ' + ep.number);
                downloadBtn.innerHTML = SVG_DOWNLOAD + ' DOWNLOAD';

                secondaryControls.appendChild(speedControl);
                secondaryControls.appendChild(downloadBtn);

                const desc = document.createElement('p');
                desc.className = 'audio-description';
                desc.textContent = ep.description;

                // Error container
                const errorDiv = document.createElement('div');
                errorDiv.className = 'audio-error';
                errorDiv.style.display = 'none';
                errorDiv.setAttribute('role', 'alert');

                // Hidden audio element
                audioElement = document.createElement('audio');
                audioElement.src = ep.audioFile;
                audioElement.volume = 0.8;
                audioElement.preload = 'metadata';

                let audioDuration = 0;

                // Audio event handlers
                audioElement.addEventListener('loadedmetadata', () => {
                    audioDuration = audioElement.duration;
                    totalTimeSpan.textContent = formatTime(audioDuration);
                    progress.setAttribute('aria-valuemax', Math.floor(audioDuration));
                    player.classList.remove('loading');
                });

                audioElement.addEventListener('timeupdate', () => {
                    const currentTime = audioElement.currentTime;
                    const percent = (currentTime / audioDuration) * 100;
                    progressFill.style.width = percent + '%';
                    progressHandle.style.left = percent + '%';
                    currentTimeSpan.textContent = formatTime(currentTime);
                    progress.setAttribute('aria-valuenow', Math.floor(currentTime));
                    progress.setAttribute('aria-valuetext', formatTimeVerbose(currentTime) + ' of ' + formatTimeVerbose(audioDuration));
                });

                audioElement.addEventListener('ended', () => {
                    isPlaying = false;
                    playBtn.setAttribute('aria-pressed', 'false');
                    playBtn.setAttribute('aria-label', 'Play ' + ep.title);
                    playBtn.innerHTML = SVG_PLAY;
                    waveform.querySelectorAll('.waveform-bar').forEach(b => b.classList.remove('active'));
                });

                audioElement.addEventListener('error', () => {
                    player.classList.remove('loading');
                    let message = 'Could not load audio.';
                    if (audioElement.error) {
                        switch (audioElement.error.code) {
                            case MediaError.MEDIA_ERR_ABORTED:
                                message = 'Audio loading was aborted.';
                                break;
                            case MediaError.MEDIA_ERR_NETWORK:
                                message = 'Network error while loading audio. Please check your connection.';
                                break;
                            case MediaError.MEDIA_ERR_DECODE:
                                message = 'Audio file appears to be corrupted or in an unsupported format.';
                                break;
                            case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:
                                message = 'Audio format not supported by your browser.';
                                break;
                        }
                    }
                    errorDiv.textContent = message;
                    errorDiv.style.display = 'block';
                });

                audioElement.addEventListener('waiting', () => player.classList.add('loading'));
                audioElement.addEventListener('canplay', () => player.classList.remove('loading'));

                // Play/Pause toggle with proper Promise handling
                function togglePlay() {
                    if (isPlaying) {
                        audioElement.pause();
                        playBtn.setAttribute('aria-pressed', 'false');
                        playBtn.setAttribute('aria-label', 'Play ' + ep.title);
                        playBtn.innerHTML = SVG_PLAY;
                        waveform.querySelectorAll('.waveform-bar').forEach(b => b.classList.remove('active'));
                        isPlaying = false;
                    } else {
                        audioElement.play()
                            .then(() => {
                                playBtn.setAttribute('aria-pressed', 'true');
                                playBtn.setAttribute('aria-label', 'Pause ' + ep.title);
                                playBtn.innerHTML = SVG_PAUSE;
                                waveform.querySelectorAll('.waveform-bar').forEach(b => b.classList.add('active'));
                                isPlaying = true;
                            })
                            .catch((err) => {
                                console.error('Playback failed:', err);
                                errorDiv.textContent = err.name === 'NotAllowedError'
                                    ? 'Please interact with the page first to enable audio.'
                                    : 'Playback failed: ' + err.message;
                                errorDiv.style.display = 'block';
                            });
                    }
                }
                playBtn.addEventListener('click', togglePlay);

                // Skip buttons
                skipBackBtn.addEventListener('click', () => {
                    audioElement.currentTime = Math.max(0, audioElement.currentTime - 15);
                });
                skipFwdBtn.addEventListener('click', () => {
                    audioElement.currentTime = Math.min(audioDuration, audioElement.currentTime + 15);
                });

                // Progress bar click
                progress.addEventListener('click', (e) => {
                    const rect = progress.getBoundingClientRect();
                    const percent = (e.clientX - rect.left) / rect.width;
                    audioElement.currentTime = percent * audioDuration;
                });

                // Progress bar keyboard navigation (WCAG)
                progress.addEventListener('keydown', (e) => {
                    const step = e.shiftKey ? 30 : 5;
                    switch (e.key) {
                        case 'ArrowRight':
                        case 'ArrowUp':
                            e.preventDefault();
                            audioElement.currentTime = Math.min(audioDuration, audioElement.currentTime + step);
                            break;
                        case 'ArrowLeft':
                        case 'ArrowDown':
                            e.preventDefault();
                            audioElement.currentTime = Math.max(0, audioElement.currentTime - step);
                            break;
                        case 'Home':
                            e.preventDefault();
                            audioElement.currentTime = 0;
                            break;
                        case 'End':
                            e.preventDefault();
                            audioElement.currentTime = audioDuration;
                            break;
                    }
                });

                // Volume control
                let savedVolume = 0.8;
                volumeSlider.addEventListener('input', () => {
                    const vol = volumeSlider.value / 100;
                    audioElement.volume = vol;
                    savedVolume = vol > 0 ? vol : savedVolume;
                    muteBtn.innerHTML = vol === 0 ? SVG_MUTED : SVG_VOLUME;
                    muteBtn.classList.toggle('muted', vol === 0);
                });

                muteBtn.addEventListener('click', () => {
                    if (audioElement.volume > 0) {
                        savedVolume = audioElement.volume;
                        audioElement.volume = 0;
                        volumeSlider.value = 0;
                        muteBtn.innerHTML = SVG_MUTED;
                        muteBtn.classList.add('muted');
                        muteBtn.setAttribute('aria-pressed', 'true');
                    } else {
                        audioElement.volume = savedVolume;
                        volumeSlider.value = savedVolume * 100;
                        muteBtn.innerHTML = SVG_VOLUME;
                        muteBtn.classList.remove('muted');
                        muteBtn.setAttribute('aria-pressed', 'false');
                    }
                });

                // Speed control
                speedSelect.addEventListener('change', () => {
                    audioElement.playbackRate = parseFloat(speedSelect.value);
                });

                // Assemble player
                inner.appendChild(title);
                inner.appendChild(subtitle);
                inner.appendChild(customPlayer);
                inner.appendChild(secondaryControls);
                inner.appendChild(audioElement);
                inner.appendChild(desc);
                inner.appendChild(errorDiv);
                player.appendChild(inner);
                contentArea.appendChild(player);
                return;
            }

            // ===== TRANSCRIPT TAB =====
            if (type === 'transcript') {
                contentArea.replaceChildren();
                const transcriptDiv = document.createElement('div');
                transcriptDiv.className = 'transcript-content';

                try {
                    const response = await fetch(ep.chronicleFile);
                    if (!response.ok) throw new Error('not found');
                    let text = await response.text();

                    // Clean for transcript
                    text = text.replace(/^---[\s\S]*?---\s*/m, '');
                    text = text.replace(/```[\s\S]*?```/g, '');
                    text = text.replace(/## Episode Metadata[\s\S]*$/, '');
                    text = text.replace(/\|.*\|/g, '');
                    text = text.replace(/^#{1,6}\s*/gm, '');
                    text = text.replace(/\*\*([^*]+)\*\*/g, '$1');
                    text = text.replace(/\*([^*]+)\*/g, '$1');
                    text = text.replace(/`[^`]+`/g, '');

                    const paragraphs = text.split(/\n\n+/).filter(p => p.trim());
                    paragraphs.forEach(p => {
                        const pEl = document.createElement('p');
                        pEl.textContent = p.trim();
                        transcriptDiv.appendChild(pEl);
                    });
                } catch (err) {
                    const errP = document.createElement('p');
                    errP.style.color = '#ff6b6b';
                    errP.textContent = 'Transcript not available.';
                    transcriptDiv.appendChild(errP);
                }
                contentArea.appendChild(transcriptDiv);
                return;
            }

            // ===== CHRONICLE / ILLUMINATION TABS =====
            const file = type === 'chronicle' ? ep.chronicleFile : ep.illuminationFile;

            try {
                const response = await fetch(file);
                if (!response.ok) throw new Error('File not found');
                const markdown = await response.text();
                await renderMarkdown(markdown);
            } catch (error) {
                contentArea.replaceChildren();
                const errorP = document.createElement('p');
                errorP.style.color = '#ff6b6b';
                errorP.textContent = 'Error loading content. Make sure you are serving from a web server.';
                contentArea.appendChild(errorP);
            }
        }

        // Format time for verbose ARIA announcements
        function formatTimeVerbose(seconds) {
            if (isNaN(seconds)) return '0 seconds';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            if (mins === 0) return secs + ' seconds';
            if (secs === 0) return mins + ' minute' + (mins !== 1 ? 's' : '');
            return mins + ' minute' + (mins !== 1 ? 's' : '') + ' ' + secs + ' seconds';
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '--:--';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return mins + ':' + String(secs).padStart(2, '0');
        }

        async function renderMarkdown(md) {
            const contentArea = document.getElementById('contentArea');

            marked.setOptions({ breaks: true, gfm: true });

            let html = marked.parse(md);

            const mermaidBlocks = [];
            html = html.replace(/<pre><code class="language-mermaid">([\s\S]*?)<\/code><\/pre>/g, function(match, code) {
                const id = 'mermaid-' + mermaidBlocks.length;
                const decoded = code.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&');
                mermaidBlocks.push({ id: id, code: decoded });
                return '<div class="mermaid" id="' + id + '"></div>';
            });

            const cleanHtml = DOMPurify.sanitize(html, {
                ADD_TAGS: ['div'],
                ADD_ATTR: ['class', 'id']
            });

            contentArea.replaceChildren();
            const wrapper = document.createElement('div');
            wrapper.innerHTML = cleanHtml;
            contentArea.appendChild(wrapper);

            for (const block of mermaidBlocks) {
                try {
                    const result = await mermaid.render(block.id + '-svg', block.code);
                    const el = document.getElementById(block.id);
                    if (el) {
                        el.innerHTML = DOMPurify.sanitize(result.svg, {
                            ADD_TAGS: ['svg', 'g', 'path', 'text', 'tspan', 'rect', 'circle', 'line', 'polygon', 'polyline', 'marker', 'defs', 'style', 'title', 'desc', 'foreignObject'],
                            ADD_ATTR: ['viewBox', 'preserveAspectRatio', 'd', 'fill', 'stroke', 'stroke-width', 'transform', 'x', 'y', 'width', 'height', 'rx', 'ry', 'cx', 'cy', 'r', 'points', 'marker-end', 'marker-start', 'text-anchor', 'dominant-baseline', 'font-size', 'font-family', 'font-weight', 'class', 'id', 'style', 'xmlns']
                        });
                    }
                } catch (e) {
                    const el = document.getElementById(block.id);
                    if (el) {
                        const pre = document.createElement('pre');
                        pre.textContent = block.code;
                        el.replaceChildren(pre);
                    }
                }
            }
        }

        function closeViewer() {
            document.getElementById('contentViewer').classList.remove('visible');
            document.querySelectorAll('.episode-card').forEach(card => card.classList.remove('active'));
            if (audioElement) {
                audioElement.pause();
                isPlaying = false;
            }
            currentEpisode = null;
        }

        // Initialize
        document.getElementById('closeBtn').addEventListener('click', closeViewer);
        createParticles();
        renderEpisodes();
    </script>
</body>
</html>

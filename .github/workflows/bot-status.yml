name: Velocity Bot Status Dashboard

on:
  schedule:
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  issues: write

concurrency:
  group: bot-status
  cancel-in-progress: true

jobs:
  update-dashboard:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Generate and publish dashboard
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const repo = { owner: context.repo.owner, repo: context.repo.repo };
            const now = new Date();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const dateFrom = weekAgo.toISOString().split('T')[0];
            const dateTo = now.toISOString().split('T')[0];

            // Query issues with bot:* labels from last 7 days
            const botLabels = ['bot:in-progress', 'bot:pr-ready', 'bot:needs-help', 'bot:failed'];
            let issuesProcessed = 0;
            let prReady = 0;
            let needsHelp = 0;
            let failed = 0;
            let inProgress = 0;

            for (const label of botLabels) {
              try {
                const issues = await github.rest.issues.listForRepo({
                  ...repo,
                  labels: label,
                  since: weekAgo.toISOString(),
                  state: 'all',
                  per_page: 100
                });

                const recentIssues = issues.data.filter(issue => {
                  const updated = new Date(issue.updated_at);
                  return updated >= weekAgo;
                });

                const count = recentIssues.length;

                switch (label) {
                  case 'bot:in-progress':
                    inProgress = count;
                    break;
                  case 'bot:pr-ready':
                    prReady = count;
                    break;
                  case 'bot:needs-help':
                    needsHelp = count;
                    break;
                  case 'bot:failed':
                    failed = count;
                    break;
                }
                issuesProcessed += count;
              } catch (e) {
                core.info(`No issues found with label ${label}: ${e.message}`);
              }
            }

            // Count PRs from claude/ branches
            let claudePRs = 0;
            try {
              const pulls = await github.rest.pulls.list({
                ...repo,
                state: 'all',
                per_page: 100,
                sort: 'created',
                direction: 'desc'
              });

              claudePRs = pulls.data.filter(pr => {
                const created = new Date(pr.created_at);
                return pr.head.ref.startsWith('claude/') && created >= weekAgo;
              }).length;
            } catch (e) {
              core.info(`Could not list PRs: ${e.message}`);
            }

            // Calculate success rate
            const completed = prReady + needsHelp + failed;
            const successRate = completed > 0
              ? ((prReady / completed) * 100).toFixed(1)
              : 'N/A';

            // Build dashboard body
            const dashboardBody = `# Velocity Bot Dashboard

            > Auto-updated weekly. Last refresh: ${dateTo}

            ## Weekly Report: ${dateFrom} to ${dateTo}

            | Metric | Count |
            |---|---|
            | Issues processed | ${issuesProcessed} |
            | PRs created (claude/ branches) | ${claudePRs} |
            | Successful (bot:pr-ready) | ${prReady} |
            | Needs help (bot:needs-help) | ${needsHelp} |
            | Failed (bot:failed) | ${failed} |
            | In progress (bot:in-progress) | ${inProgress} |
            | Success rate | ${successRate}% |

            ---
            *Generated by the velocity bot status workflow.*`.replace(/^            /gm, '');

            // Find or create the pinned dashboard issue
            const dashboardTitle = 'Velocity Bot Dashboard';
            let dashboardIssue = null;

            const existingIssues = await github.rest.issues.listForRepo({
              ...repo,
              state: 'open',
              creator: 'github-actions[bot]',
              per_page: 100
            });

            dashboardIssue = existingIssues.data.find(
              issue => issue.title === dashboardTitle
            );

            if (dashboardIssue) {
              // Update existing issue
              await github.rest.issues.update({
                ...repo,
                issue_number: dashboardIssue.number,
                body: dashboardBody
              });
              core.info(`Updated dashboard issue #${dashboardIssue.number}`);
            } else {
              // Create new issue
              const created = await github.rest.issues.create({
                ...repo,
                title: dashboardTitle,
                body: dashboardBody,
                labels: ['bot:dashboard']
              });
              core.info(`Created dashboard issue #${created.data.number}`);

              // Pin the issue
              try {
                await github.graphql(`
                  mutation {
                    pinIssue(input: { issueId: "${created.data.node_id}" }) {
                      issue { id }
                    }
                  }
                `);
                core.info('Pinned dashboard issue.');
              } catch (e) {
                core.info(`Could not pin issue: ${e.message}`);
              }
            }

# Velocity Bot - Automated issue implementation via Claude Code
#
# 3x Hardening applied: 2026-02-03
#   1. SHA-pinned all actions to consistent versions (checkout v4, upload-artifact v6)
#   2. Fixed command injection: prompt written to file via Python (no shell interpolation
#      of issue title/body), PR title sanitized to strip shell metacharacters
#   3. Added concurrency guard to prevent parallel bot runs on same issue

name: Velocity Bot

on:
  issue_comment:
    types: [created]
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

# Prevent parallel bot runs on the same issue
concurrency:
  group: velocity-bot-${{ github.event.issue.number || github.run_id }}
  cancel-in-progress: false

jobs:
  check-trigger:
    runs-on: ubuntu-latest
    if: github.actor != 'claude[bot]'
    outputs:
      should_run: ${{ steps.evaluate.outputs.should_run }}
      issue_number: ${{ steps.evaluate.outputs.issue_number }}
      issue_title: ${{ steps.evaluate.outputs.issue_title }}
      issue_body: ${{ steps.evaluate.outputs.issue_body }}
      trigger_type: ${{ steps.evaluate.outputs.trigger_type }}
      trigger_user: ${{ steps.evaluate.outputs.trigger_user }}
    steps:
      - name: Evaluate trigger
        id: evaluate
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const event = context.eventName;
            let shouldRun = false;
            let issueNumber, issueTitle, issueBody, triggerType, triggerUser;

            const allowedAssociations = ['OWNER', 'MEMBER', 'COLLABORATOR'];

            if (event === 'issues' && context.payload.action === 'labeled') {
              const label = context.payload.label.name;
              const association = context.payload.sender.author_association;
              triggerUser = context.payload.sender.login;
              triggerType = 'label';

              if (label === 'velocity' && allowedAssociations.includes(association)) {
                shouldRun = true;
                issueNumber = context.payload.issue.number;
                issueTitle = context.payload.issue.title;
                issueBody = context.payload.issue.body || '';
              }
            } else if (event === 'issue_comment' && context.payload.action === 'created') {
              const comment = context.payload.comment.body || '';
              const association = context.payload.comment.author_association;
              triggerUser = context.payload.comment.user.login;
              triggerType = 'comment';

              // Skip PR comments
              if (context.payload.issue.pull_request) {
                core.info('Skipping: comment is on a pull request, not an issue.');
                core.setOutput('should_run', 'false');
                return;
              }

              if (comment.trimStart().startsWith('/implement') && allowedAssociations.includes(association)) {
                shouldRun = true;
                issueNumber = context.payload.issue.number;
                issueTitle = context.payload.issue.title;
                issueBody = context.payload.issue.body || '';

                // Add rocket reaction to the triggering comment
                await github.rest.reactions.createForIssueComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: context.payload.comment.id,
                  content: 'rocket'
                });
              }
            }

            if (shouldRun) {
              // Sanitize issue body: strip HTML comments, invisible Unicode, limit length
              let sanitized = issueBody;
              sanitized = sanitized.replace(/<!--[\s\S]*?-->/g, '');
              sanitized = sanitized.replace(/[\u200B-\u200F\u2028-\u202F\u2060-\u206F\uFEFF\uFFF0-\uFFFF]/g, '');
              sanitized = sanitized.substring(0, 4000);

              core.setOutput('should_run', 'true');
              core.setOutput('issue_number', String(issueNumber));
              core.setOutput('issue_title', issueTitle);
              core.setOutput('issue_body', sanitized);
              core.setOutput('trigger_type', triggerType);
              core.setOutput('trigger_user', triggerUser);
            } else {
              core.setOutput('should_run', 'false');
            }

  implement:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 30
    env:
      ISSUE_NUMBER: ${{ needs.check-trigger.outputs.issue_number }}
      ISSUE_TITLE: ${{ needs.check-trigger.outputs.issue_title }}
      ISSUE_BODY: ${{ needs.check-trigger.outputs.issue_body }}
      TRIGGER_USER: ${{ needs.check-trigger.outputs.trigger_user }}
      TRIGGER_TYPE: ${{ needs.check-trigger.outputs.trigger_type }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
        with:
          fetch-depth: 0

      - name: Create working branch
        run: |
          git checkout -b "claude/issue-${ISSUE_NUMBER}"

      - name: Add in-progress label
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER, 10);
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['bot:in-progress']
            });

      - name: Post acknowledgment comment
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER, 10);
            const triggerUser = process.env.TRIGGER_USER;
            const triggerType = process.env.TRIGGER_TYPE;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `Velocity bot activated by @${triggerUser} (trigger: ${triggerType}). Working on implementation...`
            });

      - name: Build prompt file
        run: |
          # Write prompt to file to avoid shell injection from issue title/body.
          # Uses Python to safely serialize env vars without shell interpolation.
          python3 -c "
          import os
          issue_num = os.environ['ISSUE_NUMBER']
          issue_title = os.environ['ISSUE_TITLE']
          issue_body = os.environ['ISSUE_BODY']
          prompt = f'''You are implementing a GitHub issue for the WASP2 project.

          Issue #{issue_num}: {issue_title}

          {issue_body}

          Instructions:
          - Read the codebase to understand the project structure before making changes.
          - Implement the requested feature or fix described in the issue.
          - Write tests for your changes when appropriate.
          - Run tests with pytest to verify your changes work.
          - Follow existing code style and conventions.
          - Make minimal, focused changes that address the issue.'''
          with open('/tmp/claude-prompt.txt', 'w') as f:
              f.write(prompt)
          "

      - name: Run Claude implementation
        run: |
          claude --allowedTools \
            "Read" \
            "Edit" \
            "Write" \
            "Grep" \
            "Glob" \
            "Bash(git diff *)" \
            "Bash(git log *)" \
            "Bash(git status)" \
            "Bash(pytest *)" \
            "Bash(python *)" \
            "Bash(maturin *)" \
            "Bash(cargo *)" \
            "Bash(ruff *)" \
            "Bash(ls *)" \
            --max-turns 50 \
            --model sonnet \
            -p "$(cat /tmp/claude-prompt.txt)" \
            2>&1 | tee /tmp/claude-session.log

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet && git diff --cached --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "velocity-bot"
          git config user.email "velocity-bot@users.noreply.github.com"
          git add -A
          git commit -m "feat: implement issue #${ISSUE_NUMBER}

          Automated implementation by velocity-bot.
          Resolves #${ISSUE_NUMBER}"
          git push origin "claude/issue-${ISSUE_NUMBER}"

      - name: Create pull request
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          # Build PR body via file to avoid shell injection from env vars
          cat > /tmp/pr-body.md <<PREOF
          ## Summary

          Automated implementation for issue #${ISSUE_NUMBER} by velocity-bot.

          Triggered by: @${TRIGGER_USER} (${TRIGGER_TYPE})

          ## Related Issue

          Resolves #${ISSUE_NUMBER}

          ---
          *This PR was generated automatically by the velocity bot.*
          PREOF
          # Sanitize title: strip shell metacharacters
          SAFE_TITLE="$(echo "${ISSUE_TITLE}" | tr -d '`$"'\''\\' | head -c 200)"
          gh pr create \
            --title "feat: ${SAFE_TITLE} (issue #${ISSUE_NUMBER})" \
            --body-file /tmp/pr-body.md \
            --head "claude/issue-${ISSUE_NUMBER}" \
            --base main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post completion comment and update labels
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER, 10);
            const repo = { owner: context.repo.owner, repo: context.repo.repo };

            await github.rest.issues.createComment({
              ...repo,
              issue_number: issueNumber,
              body: `Implementation complete! A pull request has been created on branch \`claude/issue-${issueNumber}\`. Please review the changes.`
            });

            // Swap labels: remove bot:in-progress, add bot:pr-ready
            try {
              await github.rest.issues.removeLabel({
                ...repo,
                issue_number: issueNumber,
                name: 'bot:in-progress'
              });
            } catch (e) {
              core.info('Label bot:in-progress not found, skipping removal.');
            }
            await github.rest.issues.addLabels({
              ...repo,
              issue_number: issueNumber,
              labels: ['bot:pr-ready']
            });

      - name: Handle no changes
        if: steps.changes.outputs.has_changes == 'false'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER, 10);
            const repo = { owner: context.repo.owner, repo: context.repo.repo };

            await github.rest.issues.createComment({
              ...repo,
              issue_number: issueNumber,
              body: 'Velocity bot completed analysis but did not produce any code changes. This issue may need manual implementation or further clarification.'
            });

            // Swap labels: remove bot:in-progress, add bot:needs-help
            try {
              await github.rest.issues.removeLabel({
                ...repo,
                issue_number: issueNumber,
                name: 'bot:in-progress'
              });
            } catch (e) {
              core.info('Label bot:in-progress not found, skipping removal.');
            }
            await github.rest.issues.addLabels({
              ...repo,
              issue_number: issueNumber,
              labels: ['bot:needs-help']
            });

      - name: Handle failure
        if: failure()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER, 10);
            const repo = { owner: context.repo.owner, repo: context.repo.repo };
            const fs = require('fs');

            let logTail = 'No session log available.';
            try {
              const log = fs.readFileSync('/tmp/claude-session.log', 'utf8');
              const lines = log.split('\n');
              logTail = lines.slice(-50).join('\n');
            } catch (e) {
              core.info('Could not read session log.');
            }

            await github.rest.issues.createComment({
              ...repo,
              issue_number: issueNumber,
              body: `Velocity bot encountered an error while implementing this issue.\n\n<details>\n<summary>Last 50 lines of session log</summary>\n\n\`\`\`\n${logTail}\n\`\`\`\n\n</details>`
            });

            // Swap labels: remove bot:in-progress, add bot:failed
            try {
              await github.rest.issues.removeLabel({
                ...repo,
                issue_number: issueNumber,
                name: 'bot:in-progress'
              });
            } catch (e) {
              core.info('Label bot:in-progress not found, skipping removal.');
            }
            await github.rest.issues.addLabels({
              ...repo,
              issue_number: issueNumber,
              labels: ['bot:failed']
            });

      - name: Upload session log
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6
        with:
          name: claude-session-log-${{ needs.check-trigger.outputs.issue_number }}
          path: /tmp/claude-session.log
          retention-days: 90
          if-no-files-found: ignore

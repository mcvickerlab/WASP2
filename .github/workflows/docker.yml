# WASP2 Docker Build Workflow (Production Releases)
# Builds and pushes container images to GitHub Container Registry
# Uses self-hosted Mac runner with Docker support (wasp2-mac-runner)
#
# NOTE: For PR testing, see containers.yml (also uses self-hosted Mac runner)
#       This workflow focuses on official releases and tag pushes only

name: Docker

on:
  push:
    branches: [main]
    tags:
      - "v*"
  # PR testing is handled by containers.yml using self-hosted Mac runner
  # Keeping this commented to avoid duplicate builds
  # pull_request:
  #   branches: [main]
  #   paths:
  #     - "Dockerfile"
  #     - "rust/**"
  #     - "src/**"
  #     - "pyproject.toml"
  workflow_dispatch:

# Prevent parallel builds
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel production deployments

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    name: Build and Push
    # Using self-hosted Mac runner with Docker support
    runs-on: [self-hosted, macOS, ARM64, docker, wasp2]
    timeout-minutes: 45
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Use a temp Docker config dir to avoid macOS Keychain errors on self-hosted runners
      - name: Configure Docker credentials store
        run: |
          export DOCKER_CONFIG="$HOME/.docker-ghaction"
          mkdir -p "$DOCKER_CONFIG"
          echo '{}' > "$DOCKER_CONFIG/config.json"
          echo "DOCKER_CONFIG=$DOCKER_CONFIG" >> "$GITHUB_ENV"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix=sha-
            type=ref,event=branch

      - name: Build and push Docker image
        id: build-push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Using local cache for self-hosted runner
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          platforms: linux/amd64
          build-args: |
            VERSION=${{ github.ref_name }}

      - name: Rotate cache
        run: rm -rf /tmp/.buildx-cache && mv /tmp/.buildx-cache-new /tmp/.buildx-cache 2>/dev/null || true

      - name: Summary
        env:
          META_TAGS: ${{ steps.meta.outputs.tags }}
          IMAGE_DIGEST: ${{ steps.build-push.outputs.digest }}
          REPO_NAME: ${{ github.repository }}
        run: |
          echo "## Docker Image Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:** \`${META_TAGS//$'\n'/, }\`" >> $GITHUB_STEP_SUMMARY
          [ -n "${IMAGE_DIGEST}" ] && echo "**Digest:** \`${IMAGE_DIGEST}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Pull: \`docker pull ghcr.io/${REPO_NAME}:latest\`" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Build Singularity image from Docker (for HPC environments)
  # ===========================================================================
  singularity:
    name: Build Singularity
    needs: build
    # Using self-hosted Mac runner with Docker support
    runs-on: [self-hosted, macOS, ARM64, docker, wasp2]
    timeout-minutes: 30
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Singularity
        uses: eWaterCycle/setup-singularity@v7
        with:
          singularity-version: 3.11.4

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build Singularity image
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          singularity build wasp2_${VERSION}.sif docker://${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}

      - name: Upload Singularity image to release
        uses: softprops/action-gh-release@v1
        with:
          files: wasp2_*.sif

# Nightly Integration Tests for WASP2
# Runs extended test suite, benchmarks, and cross-platform validation
# Based on best practices from GenVarLoader, uv, and pysam projects

name: Nightly

on:
  schedule:
    # Daily at 3am UTC (after Dependabot updates)
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      test_set:
        description: 'Test set to run'
        type: choice
        default: 'all'
        options:
          - all
          - unit
          - integration
          - benchmarks
          - nextflow

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  PYTHONDONTWRITEBYTECODE: 1

jobs:
  # Planning job - determines what to run
  plan:
    name: Plan Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions: {}
    outputs:
      run_unit: ${{ steps.plan.outputs.run_unit }}
      run_integration: ${{ steps.plan.outputs.run_integration }}
      run_benchmarks: ${{ steps.plan.outputs.run_benchmarks }}
      run_nextflow: ${{ steps.plan.outputs.run_nextflow }}
    steps:
      - name: Determine test plan
        id: plan
        env:
          INPUT_TEST_SET: ${{ github.event.inputs.test_set }}
        run: |
          TEST_SET="${INPUT_TEST_SET:-all}"
          if [[ "$TEST_SET" == "all" ]]; then
            echo "run_unit=true" >> $GITHUB_OUTPUT
            echo "run_integration=true" >> $GITHUB_OUTPUT
            echo "run_benchmarks=true" >> $GITHUB_OUTPUT
            echo "run_nextflow=true" >> $GITHUB_OUTPUT
          else
            echo "run_unit=$([[ "$TEST_SET" == "unit" ]] && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "run_integration=$([[ "$TEST_SET" == "integration" ]] && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "run_benchmarks=$([[ "$TEST_SET" == "benchmarks" ]] && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "run_nextflow=$([[ "$TEST_SET" == "nextflow" ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          fi

  # Extended unit tests with coverage
  unit-tests:
    name: Extended Unit Tests
    needs: plan
    if: needs.plan.outputs.run_unit == 'true'
    runs-on: [self-hosted, macOS, ARM64, docker, wasp2]
    timeout-minutes: 30
    permissions:
      contents: read
    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
        with:
          fetch-depth: 0

      - name: Set up virtual environment
        run: |
          python -m venv .venv
          echo "$PWD/.venv/bin" >> "$GITHUB_PATH"
          .venv/bin/python --version
          .venv/bin/pip --version

      - name: Cache pip
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830  # v4
        with:
          path: ~/.cache/pip
          key: pip-nightly-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            pip-nightly-

      - name: Install dependencies
        run: |
          pip install --upgrade pip --quiet
          pip install maturin pytest pytest-cov pytest-xdist --quiet

      - name: Build Rust extension
        run: cd rust && maturin develop --release

      - name: Install package
        run: pip install -e ".[dev]" --no-build-isolation --prefer-binary --quiet || pip install -e "." --prefer-binary --quiet

      - name: Run unit tests with coverage
        run: |
          pytest tests/ -v --tb=short \
            --cov=src --cov-report=xml --cov-report=html \
            -m "not slow and not benchmark and not integration" \
            --ignore=tests/benchmarks/

      - name: Upload coverage
        uses: codecov/codecov-action@b9fd7d16f6d7d1b5d2bec1a2887e65ceed900238  # v4
        with:
          files: ./coverage.xml
          flags: nightly
          fail_ci_if_error: false

  # Integration tests
  integration-tests:
    name: Integration Tests
    needs: plan
    if: needs.plan.outputs.run_integration == 'true'
    runs-on: [self-hosted, macOS, ARM64, docker, wasp2]
    timeout-minutes: 60
    permissions:
      contents: read
    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up virtual environment
        run: |
          python -m venv .venv
          echo "$PWD/.venv/bin" >> "$GITHUB_PATH"
          .venv/bin/python --version
          .venv/bin/pip --version

      - name: Cache pip
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830  # v4
        with:
          path: ~/.cache/pip
          key: pip-integration-${{ hashFiles('pyproject.toml') }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip --quiet
          pip install maturin pytest --quiet

      - name: Build Rust extension
        run: cd rust && maturin develop --release

      - name: Install package
        run: pip install -e ".[dev]" --no-build-isolation --prefer-binary --quiet || pip install -e "." --prefer-binary --quiet

      - name: Run integration tests
        run: |
          pytest tests/ -v --tb=short -m "integration" -s

      - name: Verify CLI tools
        run: |
          wasp2-count --help
          wasp2-map --help
          wasp2-analyze --help
          python -c "import wasp2_rust; print('Rust extension OK')"

  # Performance benchmarks
  benchmarks:
    name: Performance Benchmarks
    needs: plan
    if: needs.plan.outputs.run_benchmarks == 'true'
    runs-on: [self-hosted, macOS, ARM64, docker, wasp2]
    timeout-minutes: 90
    permissions:
      contents: read
    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up virtual environment
        run: |
          python -m venv .venv
          echo "$PWD/.venv/bin" >> "$GITHUB_PATH"
          .venv/bin/python --version
          .venv/bin/pip --version

      - name: Cache benchmark data
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830  # v4
        with:
          path: |
            tests/data/benchmark_cache/
            ~/.cache/wasp2/
          key: benchmark-data-${{ hashFiles('tests/benchmarks/**') }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip --quiet
          pip install maturin pytest pytest-benchmark --quiet

      - name: Build Rust extension
        run: cd rust && maturin develop --release

      - name: Install package
        run: pip install -e ".[dev]" --no-build-isolation --prefer-binary --quiet || pip install -e "." --prefer-binary --quiet

      - name: Run benchmarks
        run: |
          pytest tests/ -v --tb=short -m "benchmark" \
            --benchmark-only \
            --benchmark-autosave \
            --benchmark-compare \
            --benchmark-json=benchmark-results.json

      - name: Upload benchmark results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6
        with:
          name: benchmark-results-${{ github.run_id }}
          path: |
            .benchmarks/
            benchmark-results.json

  # Nextflow pipeline tests (optional, expensive)
  # Uses GitHub-hosted runners since Nextflow/STAR aren't on the self-hosted runner
  nextflow-tests:
    name: Nextflow Pipeline Tests
    needs: plan
    if: needs.plan.outputs.run_nextflow == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 120
    permissions:
      contents: read
    continue-on-error: true

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6
        with:
          python-version: "3.11"

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7  # stable

      - name: Cache Rust
        uses: Swatinem/rust-cache@ad397744b0d591a723ab90405b7247fac0e6b8db  # v2
        with:
          workspaces: rust

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libhts-dev libbz2-dev liblzma-dev zlib1g-dev \
            samtools bcftools tabix

      - name: Install Nextflow
        run: |
          curl -fsSL https://get.nextflow.io | bash
          sudo mv nextflow /usr/local/bin/

      - name: Build WASP2
        run: |
          pip install maturin
          maturin build --release -m rust/Cargo.toml
          pip install rust/target/wheels/*.whl
          pip install -e ".[dev]" --no-build-isolation || pip install -e "."

      - name: Run Nextflow tests
        working-directory: pipelines/nf-rnaseq
        run: |
          nextflow run . -profile test --outdir test_output
        env:
          NXF_ANSI_LOG: false

      - name: Upload Nextflow logs
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6
        with:
          name: nextflow-logs
          path: |
            pipelines/nf-rnaseq/.nextflow.log
            pipelines/nf-rnaseq/test_output/

  # Summary job
  nightly-summary:
    name: Nightly Summary
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions: {}
    needs: [unit-tests, integration-tests, benchmarks, nextflow-tests]
    if: always()

    steps:
      - name: Check results
        env:
          UNIT_RESULT: ${{ needs.unit-tests.result }}
          INTEGRATION_RESULT: ${{ needs.integration-tests.result }}
          BENCHMARKS_RESULT: ${{ needs.benchmarks.result }}
          NEXTFLOW_RESULT: ${{ needs.nextflow-tests.result }}
        run: |
          echo "## Nightly Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | $UNIT_RESULT |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration | $INTEGRATION_RESULT |" >> $GITHUB_STEP_SUMMARY
          echo "| Benchmarks | $BENCHMARKS_RESULT |" >> $GITHUB_STEP_SUMMARY
          echo "| Nextflow | $NEXTFLOW_RESULT |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if critical tests failed
        env:
          UNIT_RESULT: ${{ needs.unit-tests.result }}
          INTEGRATION_RESULT: ${{ needs.integration-tests.result }}
        run: |
          if [[ "$UNIT_RESULT" == "failure" ]] || [[ "$INTEGRATION_RESULT" == "failure" ]]; then
            exit 1
          fi

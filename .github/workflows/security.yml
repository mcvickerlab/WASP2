# Security scanning workflow for WASP2
# Configured for self-hosted Mac ARM64 runner
# Security scans are informational - failures logged but don't block PRs
# Exception: gitleaks (secret detection) will fail the build if secrets found
#
# Security audit completed: 2026-02-03 (issue #201)
# 3x Hardening applied: 2026-02-03
#   - SARIF output for GitHub Security tab integration
#   - Lockfile validation to prevent supply chain attacks
#   - Semgrep OWASP Top 10 and security audit rules
#
# Suppressed warnings (audited 2026-02-03):
#   pip-audit/bandit: exit code suppressed (|| true) because these are
#     informational scans. Findings are reviewed manually, not gated.
#   cargo-audit: exit code suppressed (|| true). Known informational warnings:
#     - RUSTSEC-2025-0058 (custom_derive unmaintained) - transitive dep via rust-htslib
#     - RUSTSEC-2024-0436 (paste unmaintained) - transitive dep via rv, argmin
#     - RUSTSEC-2026-0002 (lru unsound IterMut) - transitive dep via rv; we
#       don't call IterMut on the LRU cache
#   gitleaks: uses .gitleaks.toml to allowlist known false positives (cache keys)
#
# Code review findings (2026-02-03):
#   - All subprocess calls use list format (no shell=True) - SAFE
#   - No os.system, eval, or exec usage - SAFE
#   - No hardcoded secrets found
#   - All dependencies are necessary (scanpy used in tutorials/docs)

name: Security

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  schedule:
    - cron: '0 5 * * 1'  # Weekly Monday 5am UTC

permissions:
  contents: read
  security-events: write  # Required for SARIF upload

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # HARDENING #1: SARIF Integration for GitHub Security Tab
  # ═══════════════════════════════════════════════════════════════════════════
  bandit-sarif:
    name: Bandit Security Scan (SARIF)
    runs-on: [self-hosted, macOS, ARM64, docker, wasp2]
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Run bandit with SARIF output
        run: |
          python3 -m venv .venv-bandit
          source .venv-bandit/bin/activate
          pip install "bandit[toml]" --quiet
          bandit -c pyproject.toml -r src/ -f sarif -o bandit-results.sarif -ll || true
          bandit -c pyproject.toml -r src/ -ll || true

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('bandit-results.sarif') != ''
        with:
          sarif_file: bandit-results.sarif
          category: bandit

  pip-audit:
    name: Python Dependency Audit
    runs-on: [self-hosted, macOS, ARM64, docker, wasp2]
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Run pip-audit
        run: |
          python3 -m venv .venv-audit
          source .venv-audit/bin/activate
          pip install pip-audit --quiet
          pip-audit --strict || true

  cargo-audit:
    name: Rust Dependency Audit
    runs-on: [self-hosted, macOS, ARM64, docker, wasp2]
    timeout-minutes: 10
    defaults:
      run:
        working-directory: rust
    steps:
      - uses: actions/checkout@v4

      - name: Install cargo-audit
        working-directory: .
        run: cargo install cargo-audit --quiet 2>/dev/null || true

      - name: Run cargo audit
        run: |
          rm -f ~/.cargo/advisory-db.lock 2>/dev/null || true
          cargo audit || true

  gitleaks:
    name: Secret Detection
    runs-on: [self-hosted, macOS, ARM64, docker, wasp2]
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install gitleaks
        run: |
          if ! command -v gitleaks &> /dev/null; then
            curl -sSfL https://github.com/gitleaks/gitleaks/releases/download/v8.18.4/gitleaks_8.18.4_darwin_arm64.tar.gz | tar xz
            mkdir -p ~/.local/bin
            mv gitleaks ~/.local/bin/
          fi

      - name: Run Gitleaks
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          gitleaks detect --source . --verbose --redact --config .gitleaks.toml

  # ═══════════════════════════════════════════════════════════════════════════
  # HARDENING #2: Lockfile Validation (Supply Chain Security)
  # ═══════════════════════════════════════════════════════════════════════════
  lockfile-check:
    name: Lockfile Validation
    runs-on: [self-hosted, macOS, ARM64, docker, wasp2]
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Verify Cargo.lock exists
        run: |
          if [ ! -f rust/Cargo.lock ]; then
            echo "ERROR: rust/Cargo.lock not found!"
            exit 1
          fi
          echo "rust/Cargo.lock exists"

      - name: Verify Cargo.lock is up-to-date
        working-directory: rust
        run: cargo check --locked 2>&1 || exit 1

      - name: Check Python dependency pinning
        run: |
          if grep -E '^\s+"[a-z]+",$' pyproject.toml 2>/dev/null; then
            echo "WARNING: Found unpinned Python dependencies"
          fi

  # ═══════════════════════════════════════════════════════════════════════════
  # HARDENING #3: Semgrep Path Traversal & OWASP Checks
  # ═══════════════════════════════════════════════════════════════════════════
  semgrep:
    name: Semgrep Security Scan
    runs-on: [self-hosted, macOS, ARM64, docker, wasp2]
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep security rules
        run: |
          python3 -m venv .venv-semgrep
          source .venv-semgrep/bin/activate
          pip install semgrep --quiet
          semgrep scan \
            --config "p/python" \
            --config "p/security-audit" \
            --config "p/owasp-top-ten" \
            --sarif --output semgrep-results.sarif \
            src/ || true

      - name: Upload Semgrep SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('semgrep-results.sarif') != ''
        with:
          sarif_file: semgrep-results.sarif
          category: semgrep

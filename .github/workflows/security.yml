# Security scanning workflow for WASP2
# Configured for self-hosted Mac runner with Docker
# Security scans are informational - failures logged but don't block PRs
# Exception: gitleaks (secret detection) will fail the build if secrets found
#
# Suppressed warnings (audited 2026-02-02):
#   pip-audit/bandit: exit code suppressed (|| true) because these are
#     informational scans. Findings are reviewed manually, not gated.
#   cargo-audit: exit code suppressed (|| true). Known informational warnings:
#     - RUSTSEC-2025-0058 (custom_derive unmaintained) - transitive dep via rust-htslib
#     - RUSTSEC-2024-0436 (paste unmaintained) - transitive dep via rv, argmin
#     - RUSTSEC-2026-0002 (lru unsound IterMut) - transitive dep via rv; we
#       don't call IterMut on the LRU cache
#   Real vulnerability tracked:
#     - RUSTSEC-2025-0020 (pyo3 buffer overflow) - fix via dependabot PR #217 (pending)

name: Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly security scan on Monday at 5am UTC
    - cron: '0 5 * * 1'

permissions:
  contents: read

jobs:
  pip-audit:
    name: Python Dependency Audit
    runs-on: [self-hosted, macOS, ARM64, docker, wasp2]
    timeout-minutes: 10
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - name: Run pip-audit
        run: |
          python3 -m venv .venv-audit
          source .venv-audit/bin/activate
          pip install pip-audit --quiet
          pip-audit --no-require-hashes --strict || true

  bandit:
    name: Bandit Security Scan
    runs-on: [self-hosted, macOS, ARM64, docker, wasp2]
    timeout-minutes: 10
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - name: Run bandit
        run: |
          python3 -m venv .venv-bandit
          source .venv-bandit/bin/activate
          pip install "bandit[toml]" --quiet
          bandit -c pyproject.toml -r src/ -ll || true

  cargo-audit:
    name: Rust Dependency Audit
    runs-on: [self-hosted, macOS, ARM64, docker, wasp2]
    timeout-minutes: 10
    defaults:
      run:
        shell: bash
        working-directory: rust
    steps:
      - uses: actions/checkout@v4

      - name: Install cargo-audit
        working-directory: .
        run: cargo install cargo-audit --quiet 2>/dev/null || true

      - name: Run cargo audit
        run: |
          rm -f ~/.cargo/advisory-db.lock 2>/dev/null || true
          cargo audit || true

  gitleaks:
    name: Secret Detection
    runs-on: [self-hosted, macOS, ARM64, docker, wasp2]
    timeout-minutes: 10
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install gitleaks
        run: |
          if ! command -v gitleaks &> /dev/null; then
            # Gitleaks v8.18.4 - review for updates quarterly
            curl -sSfL https://github.com/gitleaks/gitleaks/releases/download/v8.18.4/gitleaks_8.18.4_darwin_arm64.tar.gz | tar xz
            mkdir -p ~/.local/bin
            mv gitleaks ~/.local/bin/
          fi

      - name: Run Gitleaks
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          gitleaks detect --source . --verbose --redact

# WASP2 Continuous Integration Workflow
# Runs on all PRs and pushes to main/dev
# Configured for self-hosted Mac ARM64 runner
# Optimized with caching for faster builds

name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  PIP_DISABLE_PIP_VERSION_CHECK: 1
  PIP_NO_WARN_SCRIPT_LOCATION: 1

jobs:
  # ===========================================================================
  # Linting and Code Quality
  # ===========================================================================
  lint:
    name: Lint
    runs-on: [self-hosted, macOS, ARM64, docker, wasp2]
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - name: Set up virtual environment
        run: |
          python -m venv .venv
          echo "$PWD/.venv/bin" >> "$GITHUB_PATH"
          .venv/bin/python --version
          .venv/bin/pip --version

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-lint-${{ runner.os }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: pip-lint-${{ runner.os }}-

      - name: Install lint tools
        run: pip install ruff mypy --quiet

      - name: Run ruff linter
        run: ruff check src/ tests/ || true

      - name: Run ruff formatter check
        run: ruff format --check src/ tests/ || true

      - name: Run mypy
        run: mypy src/ --ignore-missing-imports || true

  # ===========================================================================
  # Security Scanning
  # ===========================================================================
  security:
    name: Security Scan
    runs-on: [self-hosted, macOS, ARM64, docker, wasp2]
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - name: Set up virtual environment
        run: |
          python -m venv .venv
          echo "$PWD/.venv/bin" >> "$GITHUB_PATH"
          .venv/bin/python --version
          .venv/bin/pip --version

      - name: Install security tools
        run: pip install "bandit[toml]>=1.8.0" --quiet

      - name: Run bandit (Python security)
        run: bandit -c pyproject.toml -r src/ || true

      - name: Run cargo-audit (Rust security)
        run: |
          cargo install cargo-audit --quiet 2>/dev/null || true
          cd rust && cargo audit || true

  # ===========================================================================
  # Build and Test
  # ===========================================================================
  test:
    name: Test
    runs-on: [self-hosted, macOS, ARM64, docker, wasp2]
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-test-${{ runner.os }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: pip-test-${{ runner.os }}-

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: cargo-registry-${{ runner.os }}-${{ hashFiles('rust/Cargo.lock') }}
          restore-keys: cargo-registry-${{ runner.os }}-

      - name: Cache Rust target
        uses: actions/cache@v4
        with:
          path: rust/target
          key: cargo-target-${{ runner.os }}-${{ hashFiles('rust/Cargo.lock', 'rust/src/**/*.rs') }}
          restore-keys: cargo-target-${{ runner.os }}-

      - name: Set up virtual environment
        run: |
          python -m venv .venv
          echo "$PWD/.venv/bin" >> "$GITHUB_PATH"
          .venv/bin/python --version
          .venv/bin/pip --version

      - name: Install build dependencies
        run: |
          # cmake is required for building zlib-ng (dependency of rust-htslib)
          command -v cmake >/dev/null 2>&1 || brew install cmake

      - name: Show environment
        run: |
          echo "Python: $(python --version)"
          echo "Rust: $(cargo --version)"
          echo "cmake: $(cmake --version | head -1)"
          echo "Samtools: $(samtools --version | head -1 || echo 'not found')"

      - name: Install Python dependencies
        run: pip install maturin pytest pytest-cov --quiet

      - name: Build Rust extension
        run: cd rust && maturin develop --release

      - name: Verify Rust extension
        run: python -c "import wasp2_rust; print(f'wasp2_rust loaded from {wasp2_rust.__file__}')"

      - name: Install package
        # Use --prefer-binary to avoid building llvmlite from source (requires LLVM)
        run: pip install -e ".[dev]" --no-build-isolation --prefer-binary --quiet || pip install -e "." --prefer-binary --quiet

      - name: Run tests with coverage
        run: |
          pytest tests/ -v --tb=short -x \
            --cov=src --cov-report=term-missing --cov-fail-under=30 \
            --ignore=tests/test_benchmark*.py \
            --ignore=tests/benchmarks/

      - name: Verify CLI tools
        run: |
          wasp2-count --help || true
          wasp2-map --help || true
          wasp2-analyze --help || true
          python -c "import wasp2_rust; print('Rust extension OK')" || true

  # ===========================================================================
  # Rust-specific checks
  # ===========================================================================
  rust:
    name: Rust Checks
    runs-on: [self-hosted, macOS, ARM64, docker, wasp2]
    defaults:
      run:
        shell: bash
        working-directory: rust
    steps:
      - uses: actions/checkout@v4

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: cargo-rust-${{ runner.os }}-${{ hashFiles('rust/Cargo.lock') }}
          restore-keys: cargo-rust-${{ runner.os }}-

      - name: Cache Rust target
        uses: actions/cache@v4
        with:
          path: rust/target
          key: cargo-target-rust-${{ runner.os }}-${{ hashFiles('rust/Cargo.lock', 'rust/src/**/*.rs') }}
          restore-keys: cargo-target-rust-${{ runner.os }}-

      - name: Check formatting
        run: cargo fmt --check || true

      - name: Run clippy
        run: cargo clippy -- -D warnings || true

      - name: Run Rust tests
        run: cargo test || true

  # ===========================================================================
  # Real Data Sanity Check (chr21)
  # Validates Rust pipeline produces consistent results on real HG00731 data
  # ===========================================================================
  sanity-test:
    name: Real Data Sanity Check (chr21)
    runs-on: [self-hosted, macOS, ARM64, docker, wasp2]
    needs: [test]  # Only run after main tests pass
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - name: Cache sanity dataset
        id: cache-sanity
        uses: actions/cache@v4
        with:
          path: tests/sanity/data
          key: wasp2-sanity-chr21-v1

      - name: Download sanity dataset
        if: steps.cache-sanity.outputs.cache-hit != 'true'
        run: |
          mkdir -p tests/sanity/data
          wget -q -O tests/sanity/data/wasp2-sanity-chr21-v1.tar.xz \
            https://github.com/Jaureguy760/WASP2-final/releases/download/v1.3.0/wasp2-sanity-chr21-v1.tar.xz
          cd tests/sanity/data
          tar -xJf wasp2-sanity-chr21-v1.tar.xz --strip-components=1
          rm -f wasp2-sanity-chr21-v1.tar.xz

      - name: Verify sanity data
        run: |
          echo "Sanity data files:"
          ls -lh tests/sanity/data/
          # Verify required files exist
          test -f tests/sanity/data/chr21.bam || exit 1
          test -f tests/sanity/data/chr21.vcf.gz || exit 1
          test -f tests/sanity/data/expected_counts.tsv || exit 1

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-sanity-${{ runner.os }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: pip-sanity-${{ runner.os }}-

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: cargo-registry-${{ runner.os }}-${{ hashFiles('rust/Cargo.lock') }}
          restore-keys: cargo-registry-${{ runner.os }}-

      - name: Cache Rust target
        uses: actions/cache@v4
        with:
          path: rust/target
          key: cargo-target-${{ runner.os }}-${{ hashFiles('rust/Cargo.lock', 'rust/src/**/*.rs') }}
          restore-keys: cargo-target-${{ runner.os }}-

      - name: Build Rust extension
        run: |
          MAMBAFORGE_PYTHON=/Users/jeffjaureguy/mambaforge/bin/python
          pip install maturin --quiet
          maturin build --release -m rust/Cargo.toml -i $MAMBAFORGE_PYTHON
          pip install rust/target/wheels/*.whl --force-reinstall --prefer-binary --quiet

      - name: Install package
        run: pip install -e ".[dev]" --no-build-isolation --prefer-binary --quiet || pip install -e "." --prefer-binary --quiet

      - name: Run sanity tests
        run: pytest tests/sanity/ -v --tb=short -x

  # ===========================================================================
  # Nextflow Integration Tests
  # NOTE: Disabled - requires GitHub-hosted runners (STAR, Nextflow, nf-test)
  # Re-enable when billing issue is resolved or self-hosted runner has these tools
  # ===========================================================================
  nf-integration:
    name: Nextflow Integration Tests
    if: false  # Disabled - requires GitHub-hosted runners
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libhts-dev \
            libbz2-dev \
            liblzma-dev \
            zlib1g-dev \
            libclang-dev \
            samtools \
            bcftools \
            tabix

      - name: Install Nextflow
        uses: nf-core/setup-nextflow@v2
        with:
          version: "24.04.0"

      - name: Install nf-test
        run: |
          curl -fsSL https://get.nf-test.com | bash
          sudo mv nf-test /usr/local/bin/

      - name: Install STAR aligner
        run: |
          wget -q https://github.com/alexdobin/STAR/archive/2.7.11b.tar.gz
          tar -xzf 2.7.11b.tar.gz
          cd STAR-2.7.11b/source
          make STAR
          sudo cp STAR /usr/local/bin/
          cd ../..
          rm -rf STAR-2.7.11b 2.7.11b.tar.gz

      - name: Build and install WASP2
        run: |
          python -m pip install --upgrade pip
          pip install maturin
          maturin build --release -m rust/Cargo.toml
          pip install target/wheels/*.whl
          pip install -e ".[dev]" --no-build-isolation

      - name: Verify WASP2 installation
        run: |
          wasp2-count --help
          wasp2-map --help

      - name: Cache integration test data
        uses: actions/cache@v4
        id: cache-test-data
        with:
          path: |
            pipelines/nf-rnaseq/tests/data/integration/star_index
            pipelines/nf-rnaseq/tests/data/integration/*.fq.gz
            pipelines/nf-rnaseq/tests/data/integration/*.vcf.gz
            pipelines/nf-rnaseq/tests/data/integration/*.vcf.gz.tbi
            pipelines/nf-rnaseq/tests/data/integration/*.fai
          key: nf-integration-test-data-${{ hashFiles('pipelines/nf-rnaseq/tests/data/integration/chr_test.fa', 'pipelines/nf-rnaseq/tests/data/integration/generate_test_data.sh') }}

      - name: Generate integration test data
        if: steps.cache-test-data.outputs.cache-hit != 'true'
        working-directory: pipelines/nf-rnaseq/tests/data/integration
        run: bash generate_test_data.sh

      - name: Run Nextflow integration tests
        working-directory: pipelines/nf-rnaseq
        run: |
          nf-test test tests/integration.nf.test \
            --profile test_integration,conda \
            --tap=test-results.tap
        env:
          NXF_ANSI_LOG: false

      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: nf-test-results
          path: |
            pipelines/nf-rnaseq/.nf-test/
            pipelines/nf-rnaseq/test-results.tap

# WASP2 Continuous Integration Workflow
# Runs on all PRs and pushes to main
# Configured for self-hosted HPC runner (tools pre-installed via conda)

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ===========================================================================
  # Linting and Code Quality
  # ===========================================================================
  lint:
    name: Lint
    runs-on: [self-hosted, linux, x64]
    steps:
      - uses: actions/checkout@v4

      - name: Run ruff linter
        run: |
          source ~/.bashrc
          ruff check src/ tests/ || true

      - name: Run ruff formatter check
        run: |
          source ~/.bashrc
          ruff format --check src/ tests/ || true

      - name: Run mypy
        run: |
          source ~/.bashrc
          pip install mypy --quiet
          mypy src/ --ignore-missing-imports || true

  # ===========================================================================
  # Security Scanning
  # ===========================================================================
  security:
    name: Security Scan
    runs-on: [self-hosted, linux, x64]
    steps:
      - uses: actions/checkout@v4

      - name: Install security tools
        run: |
          source ~/.bashrc
          pip install "bandit[toml]>=1.8.0" --quiet

      - name: Run bandit (Python security)
        run: |
          source ~/.bashrc
          bandit -c pyproject.toml -r src/ || true

      - name: Run cargo-audit (Rust security)
        run: |
          source ~/.bashrc
          cargo install cargo-audit --quiet 2>/dev/null || true
          cd rust && cargo audit || true

  # ===========================================================================
  # Build and Test
  # ===========================================================================
  test:
    name: Test
    runs-on: [self-hosted, linux, x64]
    steps:
      - uses: actions/checkout@v4

      - name: Show environment
        run: |
          source ~/.bashrc
          echo "Python: $(python3 --version)"
          echo "Rust: $(cargo --version)"
          echo "Samtools: $(samtools --version | head -1 || echo 'not found')"

      - name: Install Python dependencies
        run: |
          source ~/.bashrc
          python -m pip install --upgrade pip --quiet
          pip install maturin pytest pytest-cov --quiet

      - name: Build Rust extension
        run: |
          source ~/.bashrc
          maturin build --release -m rust/Cargo.toml
          pip install rust/target/wheels/*.whl --force-reinstall --quiet

      - name: Install package
        run: |
          source ~/.bashrc
          pip install -e ".[dev]" --no-build-isolation --quiet || pip install -e "." --quiet

      - name: Run tests
        run: |
          source ~/.bashrc
          pytest tests/ -v --tb=short -x \
            --ignore=tests/test_benchmark*.py \
            --ignore=tests/benchmarks/ || true

      - name: Verify CLI tools
        run: |
          source ~/.bashrc
          wasp2-count --help || true
          wasp2-map --help || true
          wasp2-analyze --help || true
          python -c "import wasp2_rust; print('Rust extension OK')" || true

  # ===========================================================================
  # Rust-specific checks
  # ===========================================================================
  rust:
    name: Rust Checks
    runs-on: [self-hosted, linux, x64]
    steps:
      - uses: actions/checkout@v4

      - name: Check formatting
        run: |
          source ~/.bashrc
          cd rust && cargo fmt --check || true

      - name: Run clippy
        run: |
          source ~/.bashrc
          cd rust && cargo clippy -- -D warnings || true

      - name: Run Rust tests
        run: |
          source ~/.bashrc
          cd rust && cargo test || true

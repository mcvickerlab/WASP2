"""
Module: wasp2.analysis.__main__
--------------------------------

This module defines the CLI commands for allelic imbalance analysis in WASP2.
It provides commands for bulk analysis as well as single-cell analysis, 
and for comparing differential allelic imbalance.

The available commands are:
    - find_imbalance: Analyze allelic imbalance from bulk count data.
    - find_imbalance_sc: Analyze allelic imbalance for single-cell data.
    - compare_imbalance: Compare differential allelic imbalance between groups.

Each command delegates processing to the corresponding function in the 
underlying modules.
"""

from pathlib import Path
from typing import List, Optional
from typing_extensions import Annotated

import typer
import sys

# Local Imports
from wasp2.analysis.run_analysis import run_ai_analysis
from wasp2.analysis.run_analysis_sc import run_ai_analysis_sc
from wasp2.analysis.run_compare_ai import run_ai_comparison

app = typer.Typer(pretty_exceptions_short=False)


@app.command()
def find_imbalance(
    counts: Annotated[str, typer.Argument(help="Path to the count file produced by the counting tool.")],
    min: Annotated[
        Optional[int],
        typer.Option(
            "--min",
            "--min_count",
            help="Minimum allele count required for analysis (default: 10)."
        )
    ] = None,
    pseudocount: Annotated[
        Optional[int],
        typer.Option(
            "-p",
            "--ps",
            "--pseudo",
            "--pseudocount",
            help="Pseudocount added when measuring allelic imbalance (default: 1)."
        )
    ] = None,
    out_file: Annotated[
        Optional[str],
        typer.Option(
            "--out_file",
            "--outfile",
            "--output",
            "--out",
            "-o",
            help="Path to the output file for analysis results (default: ai_results.tsv)."
        )
    ] = None,
    phased: Annotated[
        Optional[bool],
        typer.Option(
            "--phased",
            help=(
                "Calculate allelic imbalance using a phased haplotype model. "
                "Genotype information must be phased and included in the count data. "
                "If not set, the command calculates imbalance assuming unphased data."
            )
        )
    ] = False,
    model: Annotated[
        Optional[str],
        typer.Option(
            "-m",
            "--model",
            help=(
                "Model used for measuring the optimization parameter when finding imbalance. "
                "Recommended values are 'single' or 'linear' (default: 'single')."
            )
        )
    ] = None,
    region_col: Annotated[
        Optional[str],
        typer.Option(
            "--region_col",
            help=(
                "Name of the region column in the count file. For example, use 'region' for ATAC-seq data. "
                "Leave blank for auto-parsing if not provided."
            )
        )
    ] = None,
    groupby: Annotated[
        Optional[str],
        typer.Option(
            "--groupby",
            "--group",
            "--parent_col",
            "--parent",
            help=(
                "Specify the parent group column for reporting allelic imbalance. "
                "Not valid if no parent column exists or if using ATAC-seq peaks. "
                "If not provided, imbalance is reported at the feature level."
            )
        )
    ] = None,
) -> None:
    """
    Analyze allelic imbalance from bulk allelic count data.

    This command reads a count file generated by the counting tool, then 
    computes allelic imbalance based on the provided options. It supports both 
    phased and unphased models.

    **Usage:**
        WASP2 analysis find-imbalance [COUNTS] [OPTIONS]

    **Parameters:**
        :param counts: Path to the count file (e.g., a TSV file with SNP counts).
        :param min: Minimum allele count required for analysis (default is 10).
        :param pseudocount: A pseudocount value to avoid division by zero (default is 1).
        :param out_file: Path where the analysis results will be written (default: ai_results.tsv).
        :param phased: If set, use a phased haplotype model for analysis.
        :param model: Model type for optimization parameter ('single' or 'linear'; default: 'single').
        :param region_col: Name of the region column to use (e.g., 'region' for ATAC-seq).
        :param groupby: Column name to group results by instead of feature level.

    **Returns:**
        None. The function writes output to the specified file.
    """
    run_ai_analysis(
        count_file=counts,
        min_count=min,
        model=model,
        pseudocount=pseudocount,
        phased=phased,
        out_file=out_file,
        region_col=region_col,
        groupby=groupby,
    )
    # TODO: Add test cases for Typer commands if needed.


@app.command()
def find_imbalance_sc(
    counts: Annotated[str, typer.Argument(help="Path to the count file (in .h5ad format) for single-cell data.")],
    bc_map: Annotated[str, typer.Argument(
        help=(
            "Path to a TSV file mapping specific cell barcodes to groups. "
            "Each line should follow the format: [BARCODE] <tab> [GROUP]."
        )
    )],
    min: Annotated[
        Optional[int],
        typer.Option(
            "--min",
            "--min_count",
            help="Minimum allele count per region for analysis (default: 10)."
        )
    ] = None,
    pseudocount: Annotated[
        Optional[int],
        typer.Option(
            "-p",
            "--ps",
            "--pseudo",
            "--pseudocount",
            help="Pseudocount added when measuring allelic imbalance (default: 1)."
        )
    ] = None,
    sample: Annotated[
        Optional[str],
        typer.Option(
            "--sample",
            "--samp",
            "-s",
            help=(
                "Specify a sample name to use for parsing heterozygous genotypes "
                "if the count file contains data for multiple samples. "
                "This is required when more than one sample is present."
            )
        )
    ] = None,
    groups: Annotated[
        Optional[List[str]],
        typer.Option(
            "--groups",
            "--group",
            "--celltypes",
            "--g",
            help=(
                "Optional: Specific groups to analyze from the barcode map. "
                "If not provided, all groups in the barcode map will be used."
            )
        )
    ] = None,
    phased: Annotated[
        Optional[bool],
        typer.Option(
            "--phased/--unphased",
            help=(
                "If set to --phased, use phasing information when calculating imbalance. "
                "If --unphased, assume all haplotypes are equally likely. "
                "If not specified, the tool auto-parses the genotype data."
            )
        )
    ] = None,
    out_file: Annotated[
        Optional[str],
        typer.Option(
            "--out_file",
            "--outfile",
            "--output",
            "--out",
            "-o",
            help="Output file for the single-cell imbalance analysis (default: ai_results_[GROUP].tsv)."
        )
    ] = None,
    z_cutoff: Annotated[
        Optional[int],
        typer.Option(
            "-z",
            "--z_cutoff",
            "--zscore_cutoff",
            "--remove_outliers",
            "--remove_extreme",
            "--z_boundary",
            "--zcore_boundary",
            help=(
                "Remove SNPs and associated regions with counts exceeding the specified Z-score cutoff. "
                "This provides an extra layer of quality control. (Default: None)"
            )
        )
    ] = None,
) -> None:
    """
    Analyze allelic imbalance for single-cell data.

    This command processes a single-cell allelic count matrix (in .h5ad format)
    along with a barcode map to compute allelic imbalance at the single-cell level.
    It supports filtering based on a minimum count and allows the use of phasing 
    information.

    **Usage:**
        WASP2 analysis find-imbalance-sc [COUNTS] [BARCODE_MAP] [OPTIONS]

    **Parameters:**
        :param counts: Path to the .h5ad count file containing cell x SNP count matrix.
        :param bc_map: Path to the barcode map TSV file (format: [BARCODE]<tab>[GROUP]).
        :param min: Minimum allele count per region (default is 10).
        :param pseudocount: Pseudocount to add during imbalance calculation (default is 1).
        :param sample: (Optional) Sample name for parsing heterozygous genotypes if multiple samples exist.
        :param groups: (Optional) Specific groups to analyze; if omitted, all groups are used.
        :param phased: Flag to use phasing information (or its negation).
        :param out_file: Output file for analysis results.
        :param z_cutoff: Z-score cutoff to remove outliers (default is None).

    **Returns:**
        None. The analysis results are written to the specified output file.
    """
    if groups and len(groups) > 0:
        groups = groups[0]
    else:
        groups = None

    run_ai_analysis_sc(
        count_file=counts,
        bc_map=bc_map,
        min_count=min,
        pseudocount=pseudocount,
        phase=phased,
        sample=sample,
        groups=groups,
        out_file=out_file,
        z_cutoff=z_cutoff,
    )


@app.command()
def compare_imbalance(
    counts: Annotated[str, typer.Argument(help="Path to the count file (in .h5ad format) for single-cell data.")],
    bc_map: Annotated[str, typer.Argument(
        help=(
            "Path to a TSV file mapping cell barcodes to groups. "
            "Each line should follow the format: [BARCODE]<tab>[GROUP]."
        )
    )],
    min: Annotated[
        Optional[int],
        typer.Option(
            "--min",
            "--min_count",
            help="Minimum allele count required for analysis (default: 10)."
        )
    ] = None,
    pseudocount: Annotated[
        Optional[int],
        typer.Option(
            "-p",
            "--ps",
            "--pseudo",
            "--pseudocount",
            help="Pseudocount to add during imbalance calculation (default: 1)."
        )
    ] = None,
    sample: Annotated[
        Optional[str],
        typer.Option(
            "--sample",
            "--samp",
            "-s",
            help=(
                "Specify a sample name for parsing heterozygous genotypes if multiple samples exist. "
                "This parameter is required when the count file contains data for more than one sample."
            )
        )
    ] = None,
    groups: Annotated[
        Optional[List[str]],
        typer.Option(
            "--groups",
            "--group",
            "--celltypes",
            "--g",
            help=(
                "List of specific groups to compare. If omitted, all group combinations in the barcode map are compared."
            )
        )
    ] = None,
    phased: Annotated[
        Optional[bool],
        typer.Option(
            "--phased/--unphased",
            help=(
                "If set to --phased, uses phasing information for imbalance calculation; "
                "if --unphased, assumes equal likelihood for all haplotypes. "
                "Defaults to auto-parsing the genotype data."
            )
        )
    ] = None,
    out_file: Annotated[
        Optional[str],
        typer.Option(
            "--out_file",
            "--outfile",
            "--output",
            "--out",
            "-o",
            help=(
                "Path to the output file for the comparison results. "
                "Defaults to ai_results_[GROUP1]_[GROUP2].tsv."
            )
        )
    ] = None,
    z_cutoff: Annotated[
        Optional[int],
        typer.Option(
            "-z",
            "--z_cutoff",
            "--zscore_cutoff",
            "--remove_outliers",
            "--remove_extreme",
            "--z_boundary",
            "--zcore_boundary",
            help=(
                "Remove SNPs and associated regions whose counts exceed the specified Z-score cutoff. "
                "This acts as an extra quality control measure (default: None)."
            )
        )
    ] = None,
) -> None:
    """
    Compare differential allelic imbalance between groups in single-cell data.

    This command takes a single-cell allelic count matrix and a barcode map, then 
    compares the allelic imbalance between specified groups. It is useful for identifying 
    differences in imbalance across cell types or experimental conditions.

    **Usage:**
        WASP2 analysis compare-imbalance [COUNTS] [BARCODE_MAP] [OPTIONS]

    **Parameters:**
        :param counts: Path to the .h5ad count file for single-cell data.
        :param bc_map: Path to the barcode map TSV file (format: [BARCODE]<tab>[GROUP]).
        :param min: Minimum allele count required for analysis (default is 10).
        :param pseudocount: Pseudocount added during calculation (default is 1).
        :param sample: (Optional) A sample identifier if multiple samples are present.
        :param groups: (Optional) List of specific groups to compare; if omitted, all groups are compared.
        :param phased: Flag to use phasing information (or its negation).
        :param out_file: Path to the output file for the comparison results.
        :param z_cutoff: Z-score cutoff to remove outliers (default is None).

    **Returns:**
        None. The comparison results are written to the specified output file.
    """
    if groups and len(groups) > 0:
        groups = groups[0]
    else:
        groups = None

    run_ai_comparison(
        count_file=counts,
        bc_map=bc_map,
        min_count=min,
        pseudocount=pseudocount,
        phase=phased,
        sample=sample,
        groups=groups,
        out_file=out_file,
        z_cutoff=z_cutoff,
    )


if __name__ == "__main__":
    root_dir = Path(__file__).parent
    sys.path.append(str(root_dir))
    app()

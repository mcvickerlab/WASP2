<tool id="wasp2_make_reads" name="WASP2 Make Reads" version="@TOOL_VERSION@@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>Generate reads with swapped alleles for WASP remapping</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="bio_tools"/>

    <command detect_errors="exit_code"><![CDATA[
        @LINK_BAM@ &&
        @LINK_VARIANTS@

        mkdir -p output_dir &&

        wasp2-map make-reads
            input.bam
            $variant_file
            #if str($samples).strip()
                --samples '$samples'
            #end if
            --out_dir output_dir
            --out_json wasp_data.json
            $is_paired
            $is_phased
            $include_indels
            --threads \${GALAXY_SLOTS:-1}
            #if $advanced.max_indel_len
                --max-indel-len $advanced.max_indel_len
            #end if
            #if $advanced.max_seqs
                --max-seqs $advanced.max_seqs
            #end if
            #if $advanced.insert_qual
                --insert-qual $advanced.insert_qual
            #end if
    ]]></command>

    <inputs>
        <expand macro="bam_input"/>
        <expand macro="variant_input"/>
        <expand macro="sample_param"/>

        <param argument="--paired" name="is_paired" type="boolean"
               truevalue="--paired" falsevalue="--single"
               checked="true" label="Paired-end reads"
               help="Input reads are paired-end (recommended)"/>

        <param argument="--phased" name="is_phased" type="boolean"
               truevalue="--phased" falsevalue="--unphased"
               checked="true" label="Phased genotypes"
               help="Variant file contains phased genotypes (strongly recommended)"/>

        <expand macro="include_indels_param"/>

        <section name="advanced" title="Advanced Options" expanded="false">
            <param argument="--max-indel-len" type="integer" value="10" min="1" max="50"
                   label="Maximum indel length"
                   help="Maximum indel length to process (bp). Longer indels are skipped."/>
            <param argument="--max-seqs" type="integer" value="64" min="1" max="256"
                   label="Maximum alternate sequences"
                   help="Maximum alternate sequences per read. Reads with more variants are skipped."/>
            <param argument="--insert-qual" type="integer" value="30" min="0" max="60"
                   label="Insertion quality score"
                   help="Quality score (Phred) for inserted bases in alternate reads"/>
        </section>
    </inputs>

    <outputs>
        <data name="to_remap_fq1" format="fastqsanger.gz" from_work_dir="output_dir/*_to_remap_R1.fq.gz"
              label="${tool.name} on ${on_string}: to_remap R1"/>
        <data name="to_remap_fq2" format="fastqsanger.gz" from_work_dir="output_dir/*_to_remap_R2.fq.gz"
              label="${tool.name} on ${on_string}: to_remap R2">
            <filter>is_paired</filter>
        </data>
        <data name="keep_bam" format="bam" from_work_dir="output_dir/*_keep.bam"
              label="${tool.name} on ${on_string}: keep BAM"/>
        <data name="to_remap_bam" format="bam" from_work_dir="output_dir/*_to_remap.bam"
              label="${tool.name} on ${on_string}: to_remap BAM"/>
        <data name="wasp_json" format="json" from_work_dir="wasp_data.json"
              label="${tool.name} on ${on_string}: WASP data JSON"/>
    </outputs>

    <tests>
        <test expect_num_outputs="5">
            <param name="bam" value="test.bam"/>
            <param name="variants" value="test.vcf"/>
            <param name="is_paired" value="true"/>
            <param name="is_phased" value="true"/>
            <output name="wasp_json" ftype="json">
                <assert_contents>
                    <has_text text="keep_bam"/>
                </assert_contents>
            </output>
        </test>
    </tests>

    <help><![CDATA[
**WASP2 Make Reads**

Generates alternate reads with swapped alleles for the WASP remapping pipeline.
This is step 1 of the WASP bias-correction workflow.

**WASP Pipeline Overview**

1. **Make Reads** (this tool): Generate reads with swapped alleles
2. **Remap**: Align the generated FASTQ files with your aligner (BWA, STAR, etc.)
3. **Filter Remapped**: Keep only reads that map to the same location

**Inputs**

- **BAM file**: Original aligned reads
- **Variant file**: VCF with heterozygous variants (phased recommended)

**Outputs**

- **to_remap FASTQ**: Reads with swapped alleles to be remapped
- **keep BAM**: Reads that don't overlap variants (passed through)
- **to_remap BAM**: Original reads before allele swapping (needed for filter step)
- **WASP data JSON**: Metadata file linking outputs (used by filter step)

**Workflow**

After running this tool:

1. Remap the to_remap FASTQ files with your aligner
2. Run "WASP2 Filter Remapped" with the remapped BAM and JSON file
3. The filtered BAM can be used for unbiased allele-specific analysis

    ]]></help>

    <expand macro="creators"/>
    <expand macro="citations"/>
</tool>
